# Implementation Tasks

## 1. Database Migration

- [ ] 1.1 Criar migration SQL que renomeia tabela `TribunalConfig` → `tribunais_config`
- [ ] 1.2 Renomear colunas para snake_case (tribunalId → tribunal_id, urlBase → url_base, etc)
- [ ] 1.3 Adicionar comentários descritivos em todas as colunas (seguindo padrão das tabelas novas)
- [ ] 1.4 Adicionar nova coluna `grau_enum` do tipo `grau_tribunal`
- [ ] 1.5 Migrar dados: converter '1g' → 'primeiro_grau' e '2g' → 'segundo_grau'
- [ ] 1.6 Remover coluna antiga `grau` e renomear `grau_enum` → `grau`
- [ ] 1.7 Validar que todos os 48 registros (24 TRTs × 2 graus) foram migrados corretamente
- [ ] 1.8 Testar migration em banco local antes de aplicar

## 2. Persistence Service

- [ ] 2.1 Criar `backend/captura/services/persistence/tribunal-config-persistence.service.ts`
- [ ] 2.2 Implementar função `getConfigByTribunalAndGrau(codigo: CodigoTRT, grau: GrauTRT): Promise<TribunalConfigDb>`
- [ ] 2.3 Implementar função `listAllConfigs(): Promise<TribunalConfigDb[]>`
- [ ] 2.4 Criar query com JOIN entre `tribunais_config` e `tribunais` para obter código e nome
- [ ] 2.5 Implementar validação de `custom_timeouts` JSONB (verificar estrutura esperada)
- [ ] 2.6 Implementar tratamento de erro quando configuração não encontrada
- [ ] 2.7 Adicionar tipos TypeScript para retorno do banco (`TribunalConfigDb`)

## 3. Config Service Refactor

- [ ] 3.1 Adicionar cache em memória no `backend/captura/services/trt/config.ts`
- [ ] 3.2 Implementar `Map<string, { config: ConfigTRT, timestamp: number }>` para cache
- [ ] 3.3 Implementar função `getCachedConfig(key: string): ConfigTRT | null` com validação de TTL (5 min)
- [ ] 3.4 Implementar função `setCachedConfig(key: string, config: ConfigTRT): void`
- [ ] 3.5 Implementar função `clearConfigCache(trtCodigo?: CodigoTRT, grau?: GrauTRT): void` para invalidação
- [ ] 3.6 Refatorar `getTribunalConfig()` para ser assíncrona:
  - Verificar cache primeiro
  - Se cache miss, buscar do banco via persistence service
  - Cachear resultado antes de retornar
  - Mapear campos do banco (url_base → baseUrl, url_login_seam → loginUrl, etc)
- [ ] 3.7 Implementar `listTribunalCodes(): Promise<CodigoTRT[]>` buscando do banco
- [ ] 3.8 Implementar `isValidTribunalCode(codigo: string): Promise<boolean>` verificando no banco
- [ ] 3.9 Remover array hardcoded `tribunaisConfig` completamente
- [ ] 3.10 Adicionar tratamento de erro com log detalhado (tribunal/grau não configurado)

## 4. Update Consumers

- [ ] 4.1 Atualizar `backend/captura/services/scheduler/executar-agendamento.service.ts`:
  - Adicionar `await` na chamada de `getTribunalConfig()`
  - Linha 65
- [ ] 4.2 Atualizar `backend/captura/services/trt/acervo-geral.service.ts`:
  - Verificar se já usa config do parâmetro (sim, usa `params.config`)
  - Nenhuma mudança necessária (config vem do scheduler)
- [ ] 4.3 Atualizar `backend/captura/services/trt/audiencias.service.ts`:
  - Verificar se já usa config do parâmetro (sim, usa `params.config`)
  - Nenhuma mudança necessária
- [ ] 4.4 Atualizar `backend/captura/services/trt/arquivados.service.ts`:
  - Verificar se já usa config do parâmetro (sim, usa `params.config`)
  - Nenhuma mudança necessária
- [ ] 4.5 Atualizar `backend/captura/services/trt/pendentes-manifestacao.service.ts`:
  - Verificar se já usa config do parâmetro (sim, usa `params.config`)
  - Nenhuma mudança necessária
- [ ] 4.6 Buscar outros arquivos que possam usar `getTribunalConfig()` diretamente:
  - `rg "getTribunalConfig" --type ts -g '!node_modules'`
  - Atualizar todos com `await`

## 5. Types Update

- [ ] 5.1 Criar tipo `TribunalConfigDb` em `backend/types/captura/trt-types.ts` para representar dados do banco
- [ ] 5.2 Criar tipo `CustomTimeouts` para estrutura de timeouts customizados
- [ ] 5.3 Atualizar tipo `ConfigTRT` se necessário (adicionar `customTimeouts?: CustomTimeouts`)
- [ ] 5.4 Garantir que `GrauTRT` aceita 'primeiro_grau' e 'segundo_grau' (já aceita)

## 6. Testing

- [ ] 6.1 Adicionar testes unitários para `tribunal-config-persistence.service.ts`:
  - Mock do Supabase client
  - Testar `getConfigByTribunalAndGrau()` com sucesso
  - Testar erro quando config não encontrada
  - Testar validação de `custom_timeouts`
- [ ] 6.2 Adicionar testes para cache em `config.ts`:
  - Testar cache hit (não faz query ao banco)
  - Testar cache miss (busca do banco)
  - Testar expiração de cache após TTL
  - Testar `clearConfigCache()`
- [ ] 6.3 Testes de integração:
  - Rodar captura de acervo geral para TRT1 primeiro grau
  - Rodar captura de audiências para TRT2 segundo grau
  - Validar que configurações vieram do banco (verificar logs)
- [ ] 6.4 Testar com tribunal que não existe (deve retornar erro claro)
- [ ] 6.5 Testar com `custom_timeouts` inválido (deve usar defaults)

## 7. Documentation

- [ ] 7.1 Atualizar comentários em `config.ts` explicando que configs vêm do banco
- [ ] 7.2 Adicionar JSDoc em `getTribunalConfig()` documentando que é assíncrona
- [ ] 7.3 Atualizar `CLAUDE.md` (se mencionar configurações hardcoded) para referenciar banco
- [ ] 7.4 Adicionar comentários no SQL da migration explicando mudanças

## 8. Deployment & Validation

- [ ] 8.1 Rodar migration em banco de desenvolvimento e validar
- [ ] 8.2 Rodar aplicação localmente e testar capturas
- [ ] 8.3 Verificar logs: nenhum erro de config, cache funcionando
- [ ] 8.4 Fazer smoke test: capturar de 3-4 TRTs diferentes
- [ ] 8.5 Validar que todos os tipos de captura funcionam (acervo, audiências, pendentes, arquivados)
