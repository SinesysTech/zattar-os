#!/bin/bash

# Script para sincronizar migrations entre remoto e local
# Marca todas as migrations remotas como reverted e depois aplica as locais

echo "üîÑ Sincronizando migrations..."
echo ""

# Lista de todas as migrations remotas que n√£o existem localmente
REMOTE_MIGRATIONS=(
  20251117015313 20251117015323 20251117015333 20251117015755 20251117053702
  20251117061656 20251117062211 20251117114456 20251117153634 20251117153708
  20251118140517 20251118140524 20251118140530 20251118142534 20251118145641
  20251118145719 20251118161805 20251119170821 20251119172254 20251119181645
  20251119183818 20251119184357 20251119193300 20251121130717 20251121132208
  20251121161938 20251121200341 20251122155947 20251122185328 20251122205005
  20251122215439 20251122221153 20251123152637 20251123152733 20251123152758
  20251123155519 20251123155538 20251123174109 20251123174143 20251124050913
  20251124051513 20251124075403 20251124111215 20251124111639 20251124112219
  20251124112236 20251124162341 20251124180314 20251124200046 20251124210542
  20251124212257 20251125173046 20251125182325 20251125184126 20251125184149
  20251125185108 20251125210536 20251126123331 20251126123648 20251126123856
  20251126124123 20251126152055 20251126152345 20251126163410 20251126185956
  20251126204749 20251126215742 20251126215801 20251126215816 20251126215858
  20251126215931 20251126215945 20251126220103 20251126220119 20251126220136
  20251126220147 20251126220201 20251126220244 20251126220304 20251126220811
  20251126220944 20251126221224 20251126221444 20251126221609 20251127174222
  20251128140357 20251129204137 20251129221910 20251129222117 20251129224330
  20251130173025 20251130173434 20251130175523 20251130180812 20251201002053
  20251201002227 20251201002345 20251201114336 20251201193537 20251201193612
  20251202133845 20251202153616 20251202154821 20251202165621 20251203143418
  20251203144726 20251203233617 20251204202651 20251204205910 20251204210036
  20251204210536 20251205130229 20251205153817 20251205183722 20251205191745
  20251207132047 20251208132220 20251208132922 20251209164901 20251209202316
  20251210231315 20251210231356 20251210231445 20251210231506 20251210231523
  20251210231544 20251210232125 20251212081846 20251212081848 20251216220347
  20251217155457 20251219165248 20251219172934 20251221195243 20251221200930
  20251221201437 20251221201652 20251222150602 20251222153756 20251222154042
  20251222154106 20251222154852 20251222155505 20251222160119 20251222163903
  20251222164047 20251222171721 20251222234344 20251223000226 20251223001231
  20251223001338 20251223001351 20251223001404 20251223001421 20251223001448
  20251223001449 20251223002404 20251224123345 20251224124733 20251224160447
  20251224171102 20251226103759 20251226103824 20251226130620 20251226130810
  20251229020238 20251229220015 20251230013335 20251230013340 20251230013349
  20251230013351 20251230013443 20251230013450 20251230013456 20251230013501
  20251230013505 20251230013507 20251231083745 20260101180952 20260101184520
  20260101194423 20260101195141 20260101203925 20260101215331 20260102174446
  20260102174856 20260102175051 20260102230746 20260102231110 20260102231904
  20260102234550 20260103001112 20260103123656 20260103123714 20260104193338
  20260104193535 20260104194046 20260104194252 20260104215300 20260104231431
  20260104232241 20260105154551 20260105162443 20260105181353 20260105183629
  20260105183727 20260106020154 20260106184200 20260106212607 20260108182608
  20260108182839 20260108183953 20260108184009 20260108184028 20260108184048
  20260108184107 20260108184132 20260108184151 20260108184216 20260108184303
  20260108184343 20260108185424 20260108192125 20260112000000 20260112143517
  20260112154016 20260112161604 20260113123419 20260115185646 20260115185701
  20260115185730 20260115191139 20260115191205 20260117131358 20260117131923
  20260121093239 20260121203004 20260210151150 20260212174023 20260212181445
  20260213191009 20260213191019 20260213191035 20260213195248
)

# Processar em lotes de 10
BATCH_SIZE=10
TOTAL=${#REMOTE_MIGRATIONS[@]}
PROCESSED=0

echo "üìù Marcando ${TOTAL} migrations remotas como reverted..."
echo ""

for ((i=0; i<$TOTAL; i+=BATCH_SIZE)); do
  BATCH=("${REMOTE_MIGRATIONS[@]:i:BATCH_SIZE}")
  PROCESSED=$((PROCESSED + ${#BATCH[@]}))
  
  echo "   Processando lote $((i/BATCH_SIZE + 1))... ($PROCESSED/$TOTAL)"
  
  npx supabase migration repair --status reverted "${BATCH[@]}" > /dev/null 2>&1
  
  if [ $? -ne 0 ]; then
    echo "   ‚ö†Ô∏è  Erro no lote $((i/BATCH_SIZE + 1)), continuando..."
  fi
done

echo ""
echo "‚úÖ Migrations remotas marcadas como reverted"
echo ""
echo "üì§ Aplicando migrations locais..."
echo ""

npx supabase db push

echo ""
echo "‚úÖ Sincroniza√ß√£o conclu√≠da!"
echo ""
echo "üìã Verificar status:"
echo "   npx supabase migration list"
echo ""
