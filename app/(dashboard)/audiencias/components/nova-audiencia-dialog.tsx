'use client';

// Componente de diálogo para criar nova audiência

import * as React from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Combobox, type ComboboxOption } from '@/components/ui/combobox';
import { Loader2 } from 'lucide-react';

interface NovaAudienciaDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onSuccess: () => void;
}

interface Processo {
  id: number;
  numero_processo: string;
  polo_ativo_nome: string;
  polo_passivo_nome: string;
  trt: string;
  grau: string;
  orgao_julgador_id: number;
}

interface TipoAudiencia {
  id: number;
  descricao: string;
  is_virtual: boolean;
}

interface SalaAudiencia {
  id: number;
  nome: string;
}

interface Usuario {
  id: number;
  nome_exibicao: string;
  email_corporativo: string;
}

export function NovaAudienciaDialog({ open, onOpenChange, onSuccess }: NovaAudienciaDialogProps) {
  const [isLoading, setIsLoading] = React.useState(false);
  const [error, setError] = React.useState<string | null>(null);

  // Estados de dados
  const [processos, setProcessos] = React.useState<Processo[]>([]);
  const [tiposAudiencia, setTiposAudiencia] = React.useState<TipoAudiencia[]>([]);
  const [salas, setSalas] = React.useState<SalaAudiencia[]>([]);
  const [usuarios, setUsuarios] = React.useState<Usuario[]>([]);

  // Estados de loading
  const [loadingProcessos, setLoadingProcessos] = React.useState(false);
  const [loadingTipos, setLoadingTipos] = React.useState(false);
  const [loadingSalas, setLoadingSalas] = React.useState(false);
  const [loadingUsuarios, setLoadingUsuarios] = React.useState(false);

  // Form state
  const [processoId, setProcessoId] = React.useState<string[]>([]);
  const [dataInicio, setDataInicio] = React.useState('');
  const [horaInicio, setHoraInicio] = React.useState('');
  const [dataFim, setDataFim] = React.useState('');
  const [horaFim, setHoraFim] = React.useState('');
  const [tipoAudienciaId, setTipoAudienciaId] = React.useState<string>('');
  const [salaAudienciaId, setSalaAudienciaId] = React.useState<string>('');
  const [urlVirtual, setUrlVirtual] = React.useState('');
  const [responsavelId, setResponsavelId] = React.useState<string>('');
  const [observacoes, setObservacoes] = React.useState('');

  // Campos de endereço presencial
  const [logradouro, setLogradouro] = React.useState('');
  const [numero, setNumero] = React.useState('');
  const [complemento, setComplemento] = React.useState('');
  const [bairro, setBairro] = React.useState('');
  const [cidade, setCidade] = React.useState('');
  const [estado, setEstado] = React.useState('');
  const [cep, setCep] = React.useState('');

  // Processo selecionado
  const processoSelecionado = React.useMemo(() => {
    if (processoId.length === 0) return null;
    return processos.find((p) => p.id.toString() === processoId[0]) || null;
  }, [processoId, processos]);

  // Tipo selecionado
  const tipoSelecionado = React.useMemo(() => {
    if (!tipoAudienciaId) return null;
    return tiposAudiencia.find((t) => t.id.toString() === tipoAudienciaId) || null;
  }, [tipoAudienciaId, tiposAudiencia]);

  // Buscar processos quando o dialog abrir
  React.useEffect(() => {
    if (open && processos.length === 0) {
      buscarProcessos();
    }
  }, [open]);

  // Buscar usuários quando o dialog abrir
  React.useEffect(() => {
    if (open && usuarios.length === 0) {
      buscarUsuarios();
    }
  }, [open]);

  // Buscar tipos de audiência quando processo for selecionado
  React.useEffect(() => {
    if (processoSelecionado) {
      buscarTiposAudiencia(processoSelecionado.trt, processoSelecionado.grau);
    } else {
      setTiposAudiencia([]);
      setTipoAudienciaId('');
    }
  }, [processoSelecionado]);

  // Buscar salas quando processo for selecionado
  React.useEffect(() => {
    if (processoSelecionado) {
      buscarSalas(processoSelecionado.trt, processoSelecionado.grau, processoSelecionado.orgao_julgador_id);
    } else {
      setSalas([]);
      setSalaAudienciaId('');
    }
  }, [processoSelecionado]);

  const buscarProcessos = async () => {
    setLoadingProcessos(true);
    try {
      const response = await fetch('/api/acervo?limite=1000&ordenar_por=numero_processo&ordem=asc');
      if (!response.ok) throw new Error('Erro ao buscar processos');

      const data = await response.json();
      if (data.success && data.data?.processos) {
        setProcessos(data.data.processos);
      }
    } catch (err) {
      console.error('Erro ao buscar processos:', err);
      setError('Erro ao carregar processos');
    } finally {
      setLoadingProcessos(false);
    }
  };

  const buscarTiposAudiencia = async (trt: string, grau: string) => {
    setLoadingTipos(true);
    try {
      const response = await fetch(`/api/audiencias/tipos?trt=${trt}&grau=${grau}`);
      if (!response.ok) throw new Error('Erro ao buscar tipos de audiência');

      const data = await response.json();
      if (data.success && data.data) {
        setTiposAudiencia(data.data);
      }
    } catch (err) {
      console.error('Erro ao buscar tipos de audiência:', err);
      setError('Erro ao carregar tipos de audiência');
    } finally {
      setLoadingTipos(false);
    }
  };

  const buscarSalas = async (trt: string, grau: string, orgaoJulgadorId: number) => {
    setLoadingSalas(true);
    try {
      const response = await fetch(`/api/audiencias/salas?trt=${trt}&grau=${grau}&orgao_julgador_id=${orgaoJulgadorId}`);
      if (!response.ok) throw new Error('Erro ao buscar salas de audiência');

      const data = await response.json();
      if (data.success && data.data) {
        setSalas(data.data);
      }
    } catch (err) {
      console.error('Erro ao buscar salas de audiência:', err);
      setError('Erro ao carregar salas de audiência');
    } finally {
      setLoadingSalas(false);
    }
  };

  const buscarUsuarios = async () => {
    setLoadingUsuarios(true);
    try {
      const response = await fetch('/api/usuarios?ativo=true&limite=1000');
      if (!response.ok) throw new Error('Erro ao buscar usuários');

      const data = await response.json();
      if (data.success && data.data?.usuarios) {
        setUsuarios(data.data.usuarios);
      }
    } catch (err) {
      console.error('Erro ao buscar usuários:', err);
      setError('Erro ao carregar usuários');
    } finally {
      setLoadingUsuarios(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);

    // Validações
    if (processoId.length === 0) {
      setError('Selecione um processo');
      return;
    }

    if (!dataInicio || !horaInicio) {
      setError('Data e hora de início são obrigatórias');
      return;
    }

    if (!dataFim || !horaFim) {
      setError('Data e hora de fim são obrigatórias');
      return;
    }

    // Converter para ISO timestamps
    const dataInicioISO = `${dataInicio}T${horaInicio}:00.000Z`;
    const dataFimISO = `${dataFim}T${horaFim}:00.000Z`;

    // Montar endereço presencial se aplicável
    let enderecoPresencial = null;
    if (tipoSelecionado && !tipoSelecionado.is_virtual) {
      if (logradouro || numero || complemento || bairro || cidade || estado || cep) {
        enderecoPresencial = {
          logradouro: logradouro || undefined,
          numero: numero || undefined,
          complemento: complemento || undefined,
          bairro: bairro || undefined,
          cidade: cidade || undefined,
          estado: estado || undefined,
          cep: cep || undefined,
        };
      }
    }

    setIsLoading(true);

    try {
      const response = await fetch('/api/audiencias', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          processo_id: parseInt(processoId[0]),
          advogado_id: 1,
          data_inicio: dataInicioISO,
          data_fim: dataFimISO,
          tipo_audiencia_id: tipoAudienciaId ? parseInt(tipoAudienciaId) : undefined,
          sala_audiencia_id: salaAudienciaId ? parseInt(salaAudienciaId) : undefined,
          url_audiencia_virtual: urlVirtual || undefined,
          endereco_presencial: enderecoPresencial,
          observacoes: observacoes || undefined,
          responsavel_id: responsavelId ? parseInt(responsavelId) : undefined,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Erro ao criar audiência');
      }

      // Resetar form
      resetForm();
      onSuccess();
      onOpenChange(false);
    } catch (err) {
      console.error('Erro ao criar audiência:', err);
      setError(err instanceof Error ? err.message : 'Erro ao criar audiência');
    } finally {
      setIsLoading(false);
    }
  };

  const resetForm = () => {
    setProcessoId([]);
    setDataInicio('');
    setHoraInicio('');
    setDataFim('');
    setHoraFim('');
    setTipoAudienciaId('');
    setSalaAudienciaId('');
    setUrlVirtual('');
    setResponsavelId('');
    setObservacoes('');
    setLogradouro('');
    setNumero('');
    setComplemento('');
    setBairro('');
    setCidade('');
    setEstado('');
    setCep('');
    setError(null);
  };

  const handleClose = () => {
    resetForm();
    onOpenChange(false);
  };

  // Opções para o combobox de processos
  const processosOptions: ComboboxOption[] = React.useMemo(() => {
    return processos.map((p) => ({
      value: p.id.toString(),
      label: `${p.numero_processo} - ${p.polo_ativo_nome} vs ${p.polo_passivo_nome}`,
      searchText: `${p.numero_processo} ${p.polo_ativo_nome} ${p.polo_passivo_nome}`,
    }));
  }, [processos]);

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Nova Audiência</DialogTitle>
          <DialogDescription>
            Adicione uma nova audiência manualmente ao sistema.
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit} className="space-y-4">
          {error && (
            <div className="bg-red-50 text-red-800 p-3 rounded-md text-sm">
              {error}
            </div>
          )}

          {/* Processo - Combobox com busca */}
          <div className="space-y-2">
            <Label htmlFor="processo">Processo *</Label>
            {loadingProcessos ? (
              <div className="flex items-center gap-2 p-2 border rounded-md">
                <Loader2 className="h-4 w-4 animate-spin" />
                <span className="text-sm text-muted-foreground">Carregando processos...</span>
              </div>
            ) : (
              <Combobox
                options={processosOptions}
                value={processoId}
                onValueChange={setProcessoId}
                placeholder="Buscar por número ou nome das partes..."
                searchPlaceholder="Buscar processo..."
                emptyText="Nenhum processo encontrado."
                multiple={false}
              />
            )}
          </div>

          {/* Data e Hora de Início */}
          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="dataInicio">Data de Início *</Label>
              <Input
                id="dataInicio"
                type="date"
                value={dataInicio}
                onChange={(e) => setDataInicio(e.target.value)}
                required
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="horaInicio">Hora de Início *</Label>
              <Input
                id="horaInicio"
                type="time"
                value={horaInicio}
                onChange={(e) => setHoraInicio(e.target.value)}
                required
              />
            </div>
          </div>

          {/* Data e Hora de Fim */}
          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="dataFim">Data de Fim *</Label>
              <Input
                id="dataFim"
                type="date"
                value={dataFim}
                onChange={(e) => setDataFim(e.target.value)}
                required
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="horaFim">Hora de Fim *</Label>
              <Input
                id="horaFim"
                type="time"
                value={horaFim}
                onChange={(e) => setHoraFim(e.target.value)}
                required
              />
            </div>
          </div>

          {/* Tipo de Audiência */}
          <div className="space-y-2">
            <Label htmlFor="tipo">Tipo de Audiência</Label>
            {loadingTipos ? (
              <div className="flex items-center gap-2 p-2 border rounded-md">
                <Loader2 className="h-4 w-4 animate-spin" />
                <span className="text-sm text-muted-foreground">Carregando tipos...</span>
              </div>
            ) : !processoSelecionado ? (
              <Select disabled>
                <SelectTrigger id="tipo">
                  <SelectValue placeholder="Selecione um processo primeiro" />
                </SelectTrigger>
              </Select>
            ) : (
              <Select value={tipoAudienciaId} onValueChange={setTipoAudienciaId}>
                <SelectTrigger id="tipo">
                  <SelectValue placeholder="Selecione o tipo de audiência" />
                </SelectTrigger>
                <SelectContent>
                  {tiposAudiencia.map((tipo) => (
                    <SelectItem key={tipo.id} value={tipo.id.toString()}>
                      {tipo.descricao} {tipo.is_virtual && '(Virtual)'}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            )}
          </div>

          {/* Sala de Audiência */}
          <div className="space-y-2">
            <Label htmlFor="sala">Sala de Audiência</Label>
            {loadingSalas ? (
              <div className="flex items-center gap-2 p-2 border rounded-md">
                <Loader2 className="h-4 w-4 animate-spin" />
                <span className="text-sm text-muted-foreground">Carregando salas...</span>
              </div>
            ) : !processoSelecionado ? (
              <Select disabled>
                <SelectTrigger id="sala">
                  <SelectValue placeholder="Selecione um processo primeiro" />
                </SelectTrigger>
              </Select>
            ) : (
              <Select value={salaAudienciaId} onValueChange={setSalaAudienciaId}>
                <SelectTrigger id="sala">
                  <SelectValue placeholder="Selecione a sala de audiência" />
                </SelectTrigger>
                <SelectContent>
                  {salas.map((sala) => (
                    <SelectItem key={sala.id} value={sala.id.toString()}>
                      {sala.nome}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            )}
          </div>

          {/* Condicional: Virtual ou Presencial */}
          {tipoSelecionado && (
            <>
              {tipoSelecionado.is_virtual ? (
                // Audiência Virtual - Campo URL
                <div className="space-y-2">
                  <Label htmlFor="urlVirtual">URL da Audiência Virtual</Label>
                  <Input
                    id="urlVirtual"
                    type="url"
                    placeholder="https://zoom.us/..."
                    value={urlVirtual}
                    onChange={(e) => setUrlVirtual(e.target.value)}
                  />
                </div>
              ) : (
                // Audiência Presencial - Campos de Endereço
                <>
                  <div className="space-y-2">
                    <Label className="text-base font-semibold">Endereço da Audiência Presencial</Label>
                  </div>

                  <div className="grid grid-cols-3 gap-4">
                    <div className="col-span-2 space-y-2">
                      <Label htmlFor="logradouro">Logradouro</Label>
                      <Input
                        id="logradouro"
                        placeholder="Rua, Avenida, etc."
                        value={logradouro}
                        onChange={(e) => setLogradouro(e.target.value)}
                      />
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="numero">Número</Label>
                      <Input
                        id="numero"
                        placeholder="123"
                        value={numero}
                        onChange={(e) => setNumero(e.target.value)}
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-2">
                      <Label htmlFor="complemento">Complemento</Label>
                      <Input
                        id="complemento"
                        placeholder="Sala, Bloco, etc."
                        value={complemento}
                        onChange={(e) => setComplemento(e.target.value)}
                      />
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="bairro">Bairro</Label>
                      <Input
                        id="bairro"
                        value={bairro}
                        onChange={(e) => setBairro(e.target.value)}
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-3 gap-4">
                    <div className="col-span-2 space-y-2">
                      <Label htmlFor="cidade">Cidade</Label>
                      <Input
                        id="cidade"
                        value={cidade}
                        onChange={(e) => setCidade(e.target.value)}
                      />
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="estado">Estado</Label>
                      <Input
                        id="estado"
                        placeholder="UF"
                        maxLength={2}
                        value={estado}
                        onChange={(e) => setEstado(e.target.value.toUpperCase())}
                      />
                    </div>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="cep">CEP</Label>
                    <Input
                      id="cep"
                      placeholder="00000-000"
                      value={cep}
                      onChange={(e) => setCep(e.target.value)}
                    />
                  </div>
                </>
              )}
            </>
          )}

          {/* Responsável */}
          <div className="space-y-2">
            <Label htmlFor="responsavel">Responsável (opcional)</Label>
            {loadingUsuarios ? (
              <div className="flex items-center gap-2 p-2 border rounded-md">
                <Loader2 className="h-4 w-4 animate-spin" />
                <span className="text-sm text-muted-foreground">Carregando usuários...</span>
              </div>
            ) : (
              <Select value={responsavelId} onValueChange={setResponsavelId}>
                <SelectTrigger id="responsavel">
                  <SelectValue placeholder="Selecione um responsável" />
                </SelectTrigger>
                <SelectContent>
                  {usuarios.map((usuario) => (
                    <SelectItem key={usuario.id} value={usuario.id.toString()}>
                      {usuario.nome_exibicao} ({usuario.email_corporativo})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            )}
          </div>

          {/* Observações */}
          <div className="space-y-2">
            <Label htmlFor="observacoes">Observações</Label>
            <Textarea
              id="observacoes"
              placeholder="Anotações adicionais sobre a audiência..."
              value={observacoes}
              onChange={(e) => setObservacoes(e.target.value)}
              rows={3}
            />
          </div>

          <DialogFooter>
            <Button type="button" variant="outline" onClick={handleClose} disabled={isLoading}>
              Cancelar
            </Button>
            <Button type="submit" disabled={isLoading}>
              {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Salvar
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
