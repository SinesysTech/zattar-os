'use client';

// Componente de diálogo para criar nova obrigação (acordo/condenação)

import * as React from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Combobox, type ComboboxOption } from '@/components/ui/combobox';
import { Loader2 } from 'lucide-react';
import { useAcervo } from '@/app/_lib/hooks/use-acervo';

interface NovaObrigacaoDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onSuccess: () => void;
}

// Opções de TRT (TRT1 a TRT24)
const TRTS = Array.from({ length: 24 }, (_, i) => {
  const num = i + 1;
  return {
    value: `TRT${num}`,
    label: `TRT${num}`,
  };
});

// Opções de Grau
const GRAUS = [
  { value: 'primeiro_grau', label: '1º Grau' },
  { value: 'segundo_grau', label: '2º Grau' },
];

export function NovaObrigacaoDialog({ open, onOpenChange, onSuccess }: NovaObrigacaoDialogProps) {
  const [isLoading, setIsLoading] = React.useState(false);
  const [error, setError] = React.useState<string | null>(null);

  // Form state
  const [trt, setTrt] = React.useState<string>('');
  const [grau, setGrau] = React.useState<string>('');
  const [processoId, setProcessoId] = React.useState<string[]>([]);
  const [tipo, setTipo] = React.useState<string>('');
  const [direcao, setDirecao] = React.useState<string>('');
  const [valorTotal, setValorTotal] = React.useState('');
  const [numeroParcelas, setNumeroParcelas] = React.useState('1');
  const [dataVencimentoPrimeiraParcela, setDataVencimentoPrimeiraParcela] = React.useState('');
  const [formaDistribuicao, setFormaDistribuicao] = React.useState('');
  const [observacoes, setObservacoes] = React.useState('');

  // Buscar processos com hook quando TRT e Grau forem selecionados
  const shouldFetchProcessos = open && !!trt && !!grau;

  // Hook com params fixos para evitar re-renders
  const acervoParams = React.useMemo(() => {
    if (!shouldFetchProcessos) {
      // Retorna params que não fazem requisição real
      return { limite: 1, pagina: 1 };
    }
    return {
      trt,
      grau: grau as 'primeiro_grau' | 'segundo_grau',
      limite: 2000,
      ordenar_por: 'numero_processo' as const,
      ordem: 'asc' as const,
    };
  }, [shouldFetchProcessos, trt, grau]);

  const { processos: processosRaw, isLoading: loadingProcessos, error: processoError } = useAcervo(acervoParams);

  // Só usa processos quando deve buscar
  const processos = shouldFetchProcessos ? processosRaw : [];

  // Atualizar erro se houver problema ao buscar processos
  React.useEffect(() => {
    if (processoError && !error) {
      setError(`Erro ao carregar processos: ${processoError}`);
    }
  }, [processoError, error]);

  // Resetar processo quando TRT ou Grau mudarem
  React.useEffect(() => {
    setProcessoId([]);
  }, [trt, grau]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);

    // Validações
    if (processoId.length === 0) {
      setError('Selecione um processo');
      return;
    }

    if (!tipo) {
      setError('Selecione o tipo');
      return;
    }

    if (!direcao) {
      setError('Selecione a direção');
      return;
    }

    if (!valorTotal || parseFloat(valorTotal) <= 0) {
      setError('Valor total deve ser maior que zero');
      return;
    }

    if (!numeroParcelas || parseInt(numeroParcelas) <= 0) {
      setError('Número de parcelas deve ser maior que zero');
      return;
    }

    if (!dataVencimentoPrimeiraParcela) {
      setError('Data de vencimento da primeira parcela é obrigatória');
      return;
    }

    setIsLoading(true);

    try {
      const response = await fetch('/api/acordos-condenacoes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          processoId: parseInt(processoId[0]),
          tipo,
          direcao,
          valorTotal: parseFloat(valorTotal),
          numeroParcelas: parseInt(numeroParcelas),
          dataVencimentoPrimeiraParcela,
          formaDistribuicao: formaDistribuicao || undefined,
          observacoes: observacoes || undefined,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Erro ao criar obrigação');
      }

      // Resetar form
      resetForm();
      onSuccess();
      onOpenChange(false);
    } catch (err) {
      console.error('Erro ao criar obrigação:', err);
      setError(err instanceof Error ? err.message : 'Erro ao criar obrigação');
    } finally {
      setIsLoading(false);
    }
  };

  const resetForm = () => {
    setTrt('');
    setGrau('');
    setProcessoId([]);
    setTipo('');
    setDirecao('');
    setValorTotal('');
    setNumeroParcelas('1');
    setDataVencimentoPrimeiraParcela('');
    setFormaDistribuicao('');
    setObservacoes('');
    setError(null);
  };

  const handleClose = () => {
    resetForm();
    onOpenChange(false);
  };

  // Opções para o combobox de processos
  const processosOptions: ComboboxOption[] = React.useMemo(() => {
    return processos.map((p) => ({
      value: p.id.toString(),
      label: `${p.numero_processo} - ${p.nome_parte_autora || 'Sem nome'} vs ${p.nome_parte_re || 'Sem nome'}`,
      searchText: `${p.numero_processo} ${p.nome_parte_autora || ''} ${p.nome_parte_re || ''}`,
    }));
  }, [processos]);

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Nova Obrigação</DialogTitle>
          <DialogDescription>
            Adicione uma nova obrigação (acordo, condenação ou custas) ao sistema.
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit} className="space-y-4">
          {error && (
            <div className="bg-red-50 text-red-800 p-3 rounded-md text-sm">
              {error}
            </div>
          )}

          {/* TRT e Grau */}
          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="trt">Tribunal (TRT) *</Label>
              <Select value={trt} onValueChange={setTrt}>
                <SelectTrigger id="trt">
                  <SelectValue placeholder="Selecione o TRT" />
                </SelectTrigger>
                <SelectContent>
                  {TRTS.map((tribunal) => (
                    <SelectItem key={tribunal.value} value={tribunal.value}>
                      {tribunal.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div className="space-y-2">
              <Label htmlFor="grau">Grau *</Label>
              <Select value={grau} onValueChange={setGrau}>
                <SelectTrigger id="grau">
                  <SelectValue placeholder="Selecione o grau" />
                </SelectTrigger>
                <SelectContent>
                  {GRAUS.map((g) => (
                    <SelectItem key={g.value} value={g.value}>
                      {g.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </div>

          {/* Processo - Combobox com busca */}
          <div className="space-y-2">
            <Label htmlFor="processo">Processo *</Label>
            {!trt || !grau ? (
              <div className="flex items-center gap-2 p-2 border rounded-md bg-muted">
                <span className="text-sm text-muted-foreground">Selecione o TRT e Grau primeiro</span>
              </div>
            ) : loadingProcessos ? (
              <div className="flex items-center gap-2 p-2 border rounded-md">
                <Loader2 className="h-4 w-4 animate-spin" />
                <span className="text-sm text-muted-foreground">Carregando processos...</span>
              </div>
            ) : (
              <Combobox
                options={processosOptions}
                value={processoId}
                onValueChange={setProcessoId}
                placeholder="Buscar por número ou nome das partes..."
                searchPlaceholder="Buscar processo..."
                emptyText="Nenhum processo encontrado"
                multiple={false}
              />
            )}
          </div>

          {/* Tipo e Direção */}
          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="tipo">Tipo *</Label>
              <Select value={tipo} onValueChange={setTipo}>
                <SelectTrigger id="tipo">
                  <SelectValue placeholder="Selecione o tipo" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="acordo">Acordo</SelectItem>
                  <SelectItem value="condenacao">Condenação</SelectItem>
                  <SelectItem value="custas_processuais">Custas Processuais</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div className="space-y-2">
              <Label htmlFor="direcao">Direção *</Label>
              <Select value={direcao} onValueChange={setDirecao}>
                <SelectTrigger id="direcao">
                  <SelectValue placeholder="Selecione a direção" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="recebimento">Recebimento</SelectItem>
                  <SelectItem value="pagamento">Pagamento</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>

          {/* Valor Total e Número de Parcelas */}
          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="valorTotal">Valor Total (R$) *</Label>
              <Input
                id="valorTotal"
                type="number"
                step="0.01"
                min="0"
                placeholder="0.00"
                value={valorTotal}
                onChange={(e) => setValorTotal(e.target.value)}
                required
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="numeroParcelas">Número de Parcelas *</Label>
              <Input
                id="numeroParcelas"
                type="number"
                min="1"
                placeholder="1"
                value={numeroParcelas}
                onChange={(e) => setNumeroParcelas(e.target.value)}
                required
              />
            </div>
          </div>

          {/* Data de Vencimento da Primeira Parcela */}
          <div className="space-y-2">
            <Label htmlFor="dataVencimento">Data de Vencimento da Primeira Parcela *</Label>
            <Input
              id="dataVencimento"
              type="date"
              value={dataVencimentoPrimeiraParcela}
              onChange={(e) => setDataVencimentoPrimeiraParcela(e.target.value)}
              required
            />
          </div>

          {/* Forma de Distribuição */}
          <div className="space-y-2">
            <Label htmlFor="formaDistribuicao">Forma de Distribuição</Label>
            <Input
              id="formaDistribuicao"
              type="text"
              placeholder="Ex: 60% para cliente, 40% honorários"
              value={formaDistribuicao}
              onChange={(e) => setFormaDistribuicao(e.target.value)}
            />
          </div>

          {/* Observações */}
          <div className="space-y-2">
            <Label htmlFor="observacoes">Observações</Label>
            <Textarea
              id="observacoes"
              placeholder="Anotações adicionais sobre a obrigação..."
              value={observacoes}
              onChange={(e) => setObservacoes(e.target.value)}
              rows={3}
            />
          </div>

          <DialogFooter>
            <Button type="button" variant="outline" onClick={handleClose} disabled={isLoading}>
              Cancelar
            </Button>
            <Button type="submit" disabled={isLoading}>
              {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Salvar
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}
