# =============================================================================
# GitHub Actions: Build e Push Docker Image para Docker Hub
# =============================================================================
# Constroi a imagem Docker para linux/amd64 e envia para Docker Hub.
#
# Secrets necessarios (configurar em Settings > Secrets and variables > Actions):
#   DOCKERHUB_USERNAME            - Usuario Docker Hub (ex: sinesystec)
#   DOCKERHUB_TOKEN               - Access Token Docker Hub (nao use senha)
#   NEXT_PUBLIC_SUPABASE_URL      - URL do Supabase (obrigatorio)
#   NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY - Anon key Supabase (obrigatorio)
# =============================================================================

name: Docker Build & Push

on:
  # Push na branch master com mudancas relevantes
  push:
    branches: [master]
    paths-ignore:
      - "*.md"
      - "docs/**"
      - "openspec/**"
      - ".vscode/**"
      - "scripts/**"
      - "e2e/**"
      - "tests/**"

  # Dispatch manual via GitHub UI
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag adicional para a imagem (ex: v1.2.0)"
        required: false
        type: string

env:
  DOCKER_IMAGE: sinesystec/zattar-os
  PLATFORM: linux/amd64
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY }}

jobs:
  build-and-push:
    name: Build & Push
    runs-on: ubuntu-latest
    timeout-minutes: 60

    permissions:
      contents: read
      packages: write

    steps:
      # -----------------------------------------------------------------
      # 1. Checkout do codigo
      # -----------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------
      # 2. Validate architecture (before building)
      # -----------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies (for architecture check)
        run: npm ci --ignore-scripts --prefer-offline

      - name: Check architecture
        run: npm run check:architecture

      # -----------------------------------------------------------------
      # 3. Preflight: validar secrets obrigatorios
      # -----------------------------------------------------------------
      - name: Validate required secrets
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ env.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY: ${{ env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY }}
        run: |
          missing=()

          [[ -z "${DOCKERHUB_USERNAME:-}" ]] && missing+=("DOCKERHUB_USERNAME")
          [[ -z "${DOCKERHUB_TOKEN:-}" ]] && missing+=("DOCKERHUB_TOKEN")
          [[ -z "${NEXT_PUBLIC_SUPABASE_URL:-}" ]] && missing+=("NEXT_PUBLIC_SUPABASE_URL")
          [[ -z "${NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY:-}" ]] && missing+=("NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY")

          if (( ${#missing[@]} > 0 )); then
            echo "::error::Missing required secrets: ${missing[*]}"
            echo "## ❌ Missing required secrets" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Configure os secrets abaixo em Settings > Secrets and variables > Actions:" >> "$GITHUB_STEP_SUMMARY"
            for name in "${missing[@]}"; do
              echo "- ${name}" >> "$GITHUB_STEP_SUMMARY"
            done
            exit 1
          fi

          echo "## ✅ Required secrets validated" >> "$GITHUB_STEP_SUMMARY"
          echo "All mandatory Docker/Supabase secrets are present." >> "$GITHUB_STEP_SUMMARY"

      # -----------------------------------------------------------------
      # 4. Metadados para tags da imagem
      # -----------------------------------------------------------------
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            # Tag "latest" em push na master
            type=raw,value=latest,enable={{is_default_branch}}
            # Tag com SHA curto do commit (ex: sha-a1b2c3d)
            type=sha,prefix=sha-,format=short
            # Tag manual via workflow_dispatch
            type=raw,value=${{ inputs.tag }},enable=${{ inputs.tag != '' }}

      # -----------------------------------------------------------------
      # 5. Setup Docker Buildx (necessario para cache e platform)
      # -----------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------
      # 6. Login no Docker Hub
      # -----------------------------------------------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -----------------------------------------------------------------
      # 7. Build e Push
      # -----------------------------------------------------------------
      - name: Build and push image
        id: build_push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: ${{ env.PLATFORM }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Build args: variaveis NEXT_PUBLIC_* inlined no bundle Next.js
          build-args: |
            NEXT_PUBLIC_SUPABASE_URL=${{ env.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY=${{ env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY }}
          # Cache de layers via GitHub Actions cache (gha)
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -----------------------------------------------------------------
      # 8. Diagnostico em caso de falha do build
      # -----------------------------------------------------------------
      - name: Diagnostics (on failure)
        if: failure()
        run: |
          echo "## Diagnostics (Failure)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Runner info" >> $GITHUB_STEP_SUMMARY
          echo "- Date: $(date -u '+%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_STEP_SUMMARY
          echo "- Kernel: $(uname -a)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resource snapshot" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          df -h >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          free -h >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          docker system df >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      # -----------------------------------------------------------------
      # 9. Resumo do build
      # -----------------------------------------------------------------

      # -----------------------------------------------------------------
      - name: Build summary
        run: |
          echo "## Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.DOCKER_IMAGE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | \`${{ env.PLATFORM }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tags | ${{ steps.meta.outputs.tags }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKER_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
