# =============================================================================
# GitHub Actions: Build e Push Docker Image para Docker Hub
# =============================================================================
# Constroi a imagem Docker para linux/amd64 e envia para Docker Hub.
#
# Secrets necessarios (configurar em Settings > Secrets and variables > Actions):
#   DOCKERHUB_USERNAME            - Usuario Docker Hub (ex: sinesystec)
#   DOCKERHUB_TOKEN               - Access Token Docker Hub (nao use senha)
#   NEXT_PUBLIC_SUPABASE_URL      - URL do Supabase (obrigatorio)
#   NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY - Anon key Supabase (obrigatorio)
# =============================================================================

name: Docker Build & Push

on:
  # Push na branch master com mudancas relevantes
  push:
    branches: [master]
    paths-ignore:
      - "*.md"
      - "docs/**"
      - "openspec/**"
      - ".vscode/**"
      - "scripts/**"
      - "e2e/**"
      - "tests/**"

  # Dispatch manual via GitHub UI
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag adicional para a imagem (ex: v1.2.0)"
        required: false
        type: string

env:
  DOCKER_IMAGE: sinesystec/zattar-os
  PLATFORM: linux/amd64
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY }}

jobs:
  build-and-push:
    name: Build & Push
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      packages: write

    steps:
      # -----------------------------------------------------------------
      # 1. Checkout do codigo
      # -----------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------
      # 2. Validate architecture (before building)
      # -----------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies (for architecture check)
        run: npm ci --ignore-scripts --prefer-offline

      - name: Check architecture
        run: npm run check:architecture

      # -----------------------------------------------------------------
      # 3. Metadados para tags da imagem
      # -----------------------------------------------------------------
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            # Tag "latest" em push na master
            type=raw,value=latest,enable={{is_default_branch}}
            # Tag com SHA curto do commit (ex: sha-a1b2c3d)
            type=sha,prefix=sha-,format=short
            # Tag manual via workflow_dispatch
            type=raw,value=${{ inputs.tag }},enable=${{ inputs.tag != '' }}

      # -----------------------------------------------------------------
      # 4. Setup Docker Buildx (necessario para cache e platform)
      # -----------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------
      # 5. Login no Docker Hub
      # -----------------------------------------------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -----------------------------------------------------------------
      # 6. Build e Push
      # -----------------------------------------------------------------
      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: ${{ env.PLATFORM }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Build args: variaveis NEXT_PUBLIC_* inlined no bundle Next.js
          build-args: |
            NEXT_PUBLIC_SUPABASE_URL=${{ env.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY=${{ env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY }}
          # Cache de layers via GitHub Actions cache (gha)
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -----------------------------------------------------------------
      # 7. Resumo do build
      # -----------------------------------------------------------------
      - name: Build summary
        run: |
          echo "## Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.DOCKER_IMAGE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | \`${{ env.PLATFORM }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tags | ${{ steps.meta.outputs.tags }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKER_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
