name: Cron - Agendamentos Captura

"on":
  schedule:
    # GitHub Actions não garante execução a cada minuto; usamos 5 min como padrão.
    - cron: '*/5 * * * *'
  workflow_dispatch: {}

jobs:
  executar-agendamentos:
    name: Executar agendamentos de captura
    runs-on: ubuntu-latest
    timeout-minutes: 6

    steps:
      - name: Executar scheduler de agendamentos
        env:
          APP_URL: ${{ secrets.APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          if [ -z "$APP_URL" ]; then
            echo "Error: APP_URL is not set (secrets.APP_URL)"
            exit 1
          fi
          if [ -z "$CRON_SECRET" ]; then
            echo "Error: CRON_SECRET is not set (secrets.CRON_SECRET)"
            exit 1
          fi
          curl -X POST "$APP_URL/api/cron/executar-agendamentos" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $CRON_SECRET" \
            -w "\n\nStatus: %{http_code}\n" \
            --retry 3 \
            --retry-delay 5 \
            --retry-max-time 30 \
            --connect-timeout 10 \
            --max-time 320 \
            -f
