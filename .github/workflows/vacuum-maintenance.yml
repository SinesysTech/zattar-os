name: VACUUM Maintenance

"on":
  schedule:
    # Executa todo domingo às 3h da manhã (UTC)
    - cron: '0 3 * * 0'
  workflow_dispatch:
    # Permite execução manual via GitHub Actions UI

permissions:
  contents: read
  issues: write

jobs:
  vacuum-maintenance:
    name: Database VACUUM Maintenance
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Execute VACUUM Maintenance
        run: |
          if [ -z "$APP_URL" ]; then
            echo "Error: APP_URL is not set (secrets.APP_URL)"
            exit 1
          fi
          if [ -z "$CRON_SECRET" ]; then
            echo "Error: CRON_SECRET is not set (secrets.CRON_SECRET)"
            exit 1
          fi
          curl -X POST "$APP_URL/api/cron/vacuum-maintenance" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $CRON_SECRET" \
            -w "\n\nStatus: %{http_code}\n" \
            --retry 3 \
            --retry-delay 5 \
            --retry-max-time 30 \
            --connect-timeout 10 \
            --max-time 60
        env:
          APP_URL: ${{ secrets.APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}

      - name: Verify SUPABASE_DB_URL secret
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo "Error: SUPABASE_DB_URL is not set (secrets.SUPABASE_DB_URL)"
            exit 1
          fi

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Run VACUUM ANALYZE on critical tables
        if: always()
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          PGSSLMODE: require
        run: |
          echo "Running VACUUM ANALYZE on critical tables..."
          psql "$SUPABASE_DB_URL" -v ON_ERROR_STOP=1 <<'SQL'
          VACUUM ANALYZE public.acervo;
          VACUUM ANALYZE public.audiencias;
          VACUUM ANALYZE public.notificacoes;
          VACUUM ANALYZE public.mensagens_chat;
          VACUUM ANALYZE public.embeddings_conhecimento;
          VACUUM ANALYZE public.embeddings;
          SQL

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const body = '❌ **VACUUM Maintenance Failed**\n\nO diagnóstico de bloat não foi executado. Verifique os logs do workflow.';

            // Se existir um issue/PR associado (ex.: workflow_dispatch via issue), comenta.
            if (context.issue && context.issue.number) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: context.issue.number,
                body,
              });
              return;
            }

            // Em schedule não há `context.issue.number`; cria um issue para registrar o incidente.
            await github.rest.issues.create({
              owner,
              repo,
              title: `VACUUM Maintenance Failed (${new Date().toISOString().slice(0, 10)})`,
              body,
              labels: ['maintenance', 'database'],
            });
        continue-on-error: true
