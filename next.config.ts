import type { NextConfig } from "next";
import path from "path";
import withPWA from "@ducanh2912/next-pwa";

const nextConfig: NextConfig = {
  // Generates a build optimized for Docker, reducing image size and improving startup time
  output: "standalone",
  serverExternalPackages: [
    "pino",
    "pino-pretty",
    "thread-stream",
    // Avoid bundling Playwright (Turbopack can choke on recorder assets like .ttf)
    "playwright",
    "playwright-core",
    // PDF libraries need legacy builds for Node.js environments
    "pdf-lib",
    "pdfjs-dist",
    "@pdfjs-dist/font-data",
    "pdf-parse",
    // Redis client - Node.js only, should not be bundled for client
    "ioredis",
    "swagger-jsdoc",
  ],
  // Disables browser source maps in production to save ~500MB during build and reduce bundle size
  productionBrowserSourceMaps: false,
  // Exclude test files from compilation
  excludeDefaultMomentLocales: true,
  pageExtensions: ["tsx", "ts", "jsx", "js"].filter(
    (ext) => !ext.includes("test")
  ),
  // ESLint disabled via NEXT_LINT_DISABLED=true in Dockerfile
  // (eslint config key removed - not supported in Next.js 16)
  // Força imports granulares, reduzindo bundle em 20-30%
  // Movido de experimental para root em Next.js 13.5+
  modularizeImports: {
    "lucide-react": {
      transform: "lucide-react/dist/esm/icons/{{kebabCase member}}",
      skipDefaultConversion: true,
    },
    "date-fns": {
      transform: "date-fns/{{member}}",
    },
    "lodash": {
      transform: "lodash/{{member}}",
    },
    "@radix-ui/react-icons": {
      transform: "@radix-ui/react-icons/dist/{{member}}",
    },
    "@platejs/ai": {
      transform: "@platejs/ai/dist/{{member}}",
    },
    "@platejs/basic-nodes": {
      transform: "@platejs/basic-nodes/dist/{{member}}",
    },
    "@platejs/basic-styles": {
      transform: "@platejs/basic-styles/dist/{{member}}",
    },
    "@platejs/autoformat": {
      transform: "@platejs/autoformat/dist/{{member}}",
    },
    "@platejs/code-block": {
      transform: "@platejs/code-block/dist/{{member}}",
    },
    "@platejs/list": {
      transform: "@platejs/list/dist/{{member}}",
    },
    "@platejs/table": {
      transform: "@platejs/table/dist/{{member}}",
    },
    "recharts": {
      transform: "recharts/es6/{{member}}",
    },
  },
  experimental: {
    // Server source maps desabilitados para reduzir tamanho da imagem Docker
    serverSourceMaps: false,
    // NOTA: Warnings de "Invalid source map" do Turbopack são conhecidos no Next.js 16.0.10
    // Não há opção para desabilitar source maps do Turbopack. O warning não afeta funcionalidade.
    // Alternativas: atualizar Next.js ou desabilitar Turbopack com `turbo: false` (não recomendado)
    // Otimizar imports de pacotes grandes (melhora tree-shaking)
    optimizePackageImports: [
      // Features (existentes)
      "@/features/financeiro",
      "@/features/audiencias",
      "@/features/usuarios",
      "@/features/processos",
      "@/features/acordos",
      "@/features/dashboard",
      // Mais features com imports pesados
      "@/features/documentos",
      "@/features/partes",
      "@/features/contratos",
      "@/features/assinatura-digital",
      "@/features/pericias",
      "@/features/obrigacoes",
      "@/features/expedientes",
      // Bibliotecas (existentes)
      "date-fns",
      "lucide-react",
      // Mais bibliotecas pesadas
      "@radix-ui/react-dialog",
      "@radix-ui/react-dropdown-menu",
      "@radix-ui/react-select",
      "@radix-ui/react-popover",
      "@radix-ui/react-tooltip",
      "@platejs/core",
      "@platejs/common",
      "recharts",
      "framer-motion",
    ],
    // Melhora análise de dependências do Turbopack
    turbotrace: {
      logLevel: "error",
      logDetail: false,
      contextDirectory: process.cwd(),
    },
  },
  turbopack: {
    resolveAlias: {
      "@": path.resolve(__dirname, "src"),
      "@/lib": path.resolve(__dirname, "src/lib"),
      "@/backend": path.resolve(__dirname, "backend"),
    },
    resolveExtensions: [".tsx", ".ts", ".jsx", ".js"],
  },
  typescript: {
    // Allows builds to proceed even with TypeScript errors; useful for rapid development but risky as it may hide bugs
    // Risks: Potential runtime errors from type mismatches; consider removing and fixing errors gradually
    ignoreBuildErrors: true,
  },
  // Fetch logging desabilitado - use DEBUG_SUPABASE=true para logs legíveis
  // logging: {
  //   fetches: {
  //     fullUrl: true,
  //   },
  // },
  images: {
    formats: ["image/avif", "image/webp"],
    remotePatterns: [
      {
        protocol: "https",
        hostname: "images.unsplash.com",
      },
    ],
  },
  async headers() {
    return [
      {
        source: "/sw.js",
        headers: [
          { key: "Cache-Control", value: "public, max-age=0, must-revalidate" },
          { key: "Service-Worker-Allowed", value: "/" },
        ],
      },
      {
        source: "/workbox-:path([a-zA-Z0-9._-]+)",
        headers: [{ key: "Cache-Control", value: "public, max-age=31536000, immutable" }],
      },
      {
        source: "/manifest.json",
        headers: [{ key: "Cache-Control", value: "public, max-age=0, must-revalidate" }],
      },
    ];
  },
  allowedDevOrigins: ["192.168.1.100", "192.168.1.100:3000"],
};

// ============================================================================
// PWA Configuration (@ducanh2912/next-pwa)
// ============================================================================
// Generates a production-ready service worker with Workbox strategies.
// IMPORTANT: Requires Webpack build (use 'npm run build:prod').
// The service worker is auto-generated in public/ during build and ignored by git.
// See DEPLOY.md section "Progressive Web App (PWA)" for troubleshooting.
export default withPWA({
  // Destination folder for generated service worker files
  dest: "public",
  // Disable PWA in development to avoid caching issues
  disable: process.env.NODE_ENV === "development",
  // Automatically register the service worker (no manual registration needed)
  register: true,
  // Fallback page when offline
  fallbacks: {
    document: "/offline",
  },
  // Workbox caching strategies
  workboxOptions: {
    // Activate new service worker immediately
    skipWaiting: true,
    clientsClaim: true,
    // Increase max file size to cache to 5MB (default is 2MB) to avoid warnings for large chunks
    maximumFileSizeToCacheInBytes: 5 * 1024 * 1024,
    runtimeCaching: [
      {
        urlPattern: /^https:\/\/fonts\.(googleapis|gstatic)\.com\/.*/i,
        handler: "CacheFirst",
        options: {
          cacheName: "google-fonts",
          expiration: {
            maxEntries: 4,
            maxAgeSeconds: 365 * 24 * 60 * 60, // 1 year
          },
        },
      },
      {
        urlPattern: /\.(?:png|jpg|jpeg|svg|gif)$/,
        handler: "CacheFirst",
        options: {
          cacheName: "images",
          expiration: {
            maxEntries: 50,
            maxAgeSeconds: 30 * 24 * 60 * 60, // 30 days
          },
        },
      },
      {
        urlPattern: /\/_next\/static.+\.js$/,
        handler: "CacheFirst",
        options: {
          cacheName: "next-static-js",
          expiration: {
            maxEntries: 64,
            maxAgeSeconds: 24 * 60 * 60, // 24 hours
          },
        },
      },
      {
        // Exclude /api/health from caching - always fetch from network
        urlPattern: /\/api\/health$/,
        handler: "NetworkOnly",
      },
      {
        urlPattern: /\/api\/.*/,
        handler: "NetworkFirst",
        options: {
          cacheName: "api-cache",
          expiration: {
            maxEntries: 100,
            maxAgeSeconds: 60 * 60, // 1 hour
          },
          networkTimeoutSeconds: 10,
        },
      },
    ],
  },
})(nextConfig);
