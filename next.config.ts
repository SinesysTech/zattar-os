import type { NextConfig } from "next";
import path from "path";
import withPWA from "@ducanh2912/next-pwa";

// Bundle analyzer for performance analysis (enabled via ANALYZE=true)
// eslint-disable-next-line @typescript-eslint/no-require-imports
const withBundleAnalyzer =
  process.env.ANALYZE === "true"
    ? require("@next/bundle-analyzer")({
        enabled: true,
        analyzerMode: "static",
        reportFilename: "../scripts/results/bundle-analysis/client.html",
        openAnalyzer: false,
      })
    : (config: NextConfig) => config;

const nextConfig: NextConfig = {
  // Generates a build optimized for Docker, reducing image size and improving startup time
  output: "standalone",
  serverExternalPackages: [
    // Logging
    "pino",
    "pino-pretty",
    "thread-stream",
    // Avoid bundling Playwright (Turbopack can choke on recorder assets like .ttf)
    "playwright",
    "playwright-core",
    // PDF libraries need legacy builds for Node.js environments
    "pdf-lib",
    "pdfjs-dist",
    "@pdfjs-dist/font-data",
    "pdf-parse",
    // Redis client - Node.js only, should not be bundled for client
    "ioredis",
    "swagger-jsdoc",
    // Document manipulation libraries - Node.js only
    "docx",
    "exceljs",
    "jszip",
    "mustache",
    "papaparse",
    "ofx-js",
    // Storage clients - Node.js only
    "minio",
    "@aws-sdk/client-s3",
    "@aws-sdk/s3-request-presigner",
    // AI/ML libraries - Node.js only
    "@langchain/core",
  ],
  // Transpile ESM-only packages for compatibility
  transpilePackages: [
    // Remark/Rehype ecosystem (ESM-only)
    "remark-gfm",
    "remark-math",
    "rehype-raw",
    "rehype-sanitize",
    "unified",
    "vfile",
    "unist-util-visit",
    "hast-util-sanitize",
    "mdast-util-gfm",
  ],
  // Disables browser source maps in production to save ~500MB during build and reduce bundle size
  productionBrowserSourceMaps: false,
  // Exclude test files from compilation
  excludeDefaultMomentLocales: true,
  pageExtensions: ["tsx", "ts", "jsx", "js"].filter(
    (ext) => !ext.includes("test")
  ),
  // ESLint disabled via NEXT_LINT_DISABLED=true in Dockerfile
  // (eslint config key removed - not supported in Next.js 16)
  // Força imports granulares, reduzindo bundle em 20-30%
  // Movido de experimental para root em Next.js 13.5+
  modularizeImports: {
    "date-fns": {
      transform: "date-fns/{{member}}",
    },
    "lodash-es": {
      transform: "lodash-es/{{member}}",
    },
    "@radix-ui/react-icons": {
      transform: "@radix-ui/react-icons/dist/{{member}}",
    },
    "recharts": {
      transform: "recharts/es6/{{member}}",
    },
  },
  experimental: {
    // Server source maps desabilitados para reduzir tamanho da imagem Docker
    serverSourceMaps: false,
    // Custom cache handler for persistent caching across builds (production only)
    // Turbopack in dev mode doesn't support custom cache handlers
    ...(process.env.NODE_ENV === "production" && {
      cacheHandler: require.resolve("./cache-handler.js"),
      cacheMaxMemorySize: 0,
    }),
    // NOTA: Warnings de "Invalid source map" do Turbopack são conhecidos no Next.js 16.0.10
    // Não há opção para desabilitar source maps do Turbopack. O warning não afeta funcionalidade.
    // Alternativas: atualizar Next.js ou desabilitar Turbopack com `turbo: false` (não recomendado)
    // Otimizar imports de pacotes grandes (melhora tree-shaking)
    optimizePackageImports: [
      // Bibliotecas
      "date-fns",
      "lucide-react",
      "recharts",
      "framer-motion",
      // Radix UI - todos os componentes
      "@radix-ui/react-accordion",
      "@radix-ui/react-alert-dialog",
      "@radix-ui/react-aspect-ratio",
      "@radix-ui/react-avatar",
      "@radix-ui/react-checkbox",
      "@radix-ui/react-collapsible",
      "@radix-ui/react-context-menu",
      "@radix-ui/react-dialog",
      "@radix-ui/react-dropdown-menu",
      "@radix-ui/react-hover-card",
      "@radix-ui/react-label",
      "@radix-ui/react-menubar",
      "@radix-ui/react-navigation-menu",
      "@radix-ui/react-popover",
      "@radix-ui/react-progress",
      "@radix-ui/react-radio-group",
      "@radix-ui/react-scroll-area",
      "@radix-ui/react-select",
      "@radix-ui/react-separator",
      "@radix-ui/react-slider",
      "@radix-ui/react-switch",
      "@radix-ui/react-tabs",
      "@radix-ui/react-toast",
      "@radix-ui/react-toggle",
      "@radix-ui/react-toolbar",
      "@radix-ui/react-tooltip",
      // Plate.js - editor de texto rico
      "@platejs/core",
      "@platejs/common",
      "@platejs/ai",
      "@platejs/autoformat",
      "@platejs/basic-nodes",
      "@platejs/basic-styles",
      "@platejs/callout",
      "@platejs/caption",
      "@platejs/code-block",
      "@platejs/combobox",
      "@platejs/comment",
      "@platejs/date",
      "@platejs/dnd",
      "@platejs/docx",
      "@platejs/emoji",
      "@platejs/floating",
      "@platejs/indent",
      "@platejs/layout",
      "@platejs/link",
      "@platejs/list",
      "@platejs/markdown",
      "@platejs/math",
      "@platejs/media",
      "@platejs/mention",
      "@platejs/selection",
      "@platejs/suggestion",
      "@platejs/table",
      "@platejs/yjs",
    ],
  },
  turbopack: {
    resolveAlias: {
      "@": path.resolve(__dirname, "src"),
      "@/lib": path.resolve(__dirname, "src/lib"),
      "@/backend": path.resolve(__dirname, "backend"),
    },
    resolveExtensions: [".tsx", ".ts", ".jsx", ".js"],
  },
  typescript: {
    // Build will fail on TypeScript errors - ensures type safety
    ignoreBuildErrors: false,
  },
  // Fetch logging desabilitado - use DEBUG_SUPABASE=true para logs legíveis
  // logging: {
  //   fetches: {
  //     fullUrl: true,
  //   },
  // },
  images: {
    formats: ["image/avif", "image/webp"],
    remotePatterns: [
      {
        protocol: "https",
        hostname: "images.unsplash.com",
      },
    ],
  },
  async headers() {
    return [
      {
        source: "/sw.js",
        headers: [
          { key: "Cache-Control", value: "public, max-age=0, must-revalidate" },
          { key: "Service-Worker-Allowed", value: "/" },
        ],
      },
      {
        source: "/workbox-:path([a-zA-Z0-9._-]+)",
        headers: [{ key: "Cache-Control", value: "public, max-age=31536000, immutable" }],
      },
      {
        source: "/manifest.json",
        headers: [{ key: "Cache-Control", value: "public, max-age=0, must-revalidate" }],
      },
    ];
  },
  allowedDevOrigins: ["192.168.1.100", "192.168.1.100:3000"],
};

// ============================================================================
// PWA Configuration (@ducanh2912/next-pwa)
// ============================================================================
// Generates a production-ready service worker with Workbox strategies.
// IMPORTANT: Requires Webpack build (use 'npm run build:prod').
// The service worker is auto-generated in public/ during build and ignored by git.
// See DEPLOY.md section "Progressive Web App (PWA)" for troubleshooting.
//
// Bundle Analyzer: Set ANALYZE=true to generate bundle analysis reports
// Reports are saved to scripts/results/bundle-analysis/
export default withBundleAnalyzer(
  withPWA({
  // Destination folder for generated service worker files
  dest: "public",
  // Disable PWA in development to avoid caching issues
  disable: process.env.NODE_ENV === "development",
  // Automatically register the service worker (no manual registration needed)
  register: true,
  // Fallback page when offline
  fallbacks: {
    document: "/offline",
  },
  // Workbox caching strategies
  workboxOptions: {
    // Activate new service worker immediately
    skipWaiting: true,
    clientsClaim: true,
    // Increase max file size to cache to 5MB (default is 2MB) to avoid warnings for large chunks
    maximumFileSizeToCacheInBytes: 5 * 1024 * 1024,
    runtimeCaching: [
      {
        urlPattern: /^https:\/\/fonts\.(googleapis|gstatic)\.com\/.*/i,
        handler: "CacheFirst",
        options: {
          cacheName: "google-fonts",
          expiration: {
            maxEntries: 4,
            maxAgeSeconds: 365 * 24 * 60 * 60, // 1 year
          },
        },
      },
      {
        urlPattern: /\.(?:png|jpg|jpeg|svg|gif)$/,
        handler: "CacheFirst",
        options: {
          cacheName: "images",
          expiration: {
            maxEntries: 50,
            maxAgeSeconds: 30 * 24 * 60 * 60, // 30 days
          },
        },
      },
      {
        urlPattern: /\/_next\/static.+\.js$/,
        handler: "CacheFirst",
        options: {
          cacheName: "next-static-js",
          expiration: {
            maxEntries: 64,
            maxAgeSeconds: 24 * 60 * 60, // 24 hours
          },
        },
      },
      {
        // Exclude /api/health from caching - always fetch from network
        urlPattern: /\/api\/health$/,
        handler: "NetworkOnly",
      },
      {
        urlPattern: /\/api\/.*/,
        handler: "NetworkFirst",
        options: {
          cacheName: "api-cache",
          expiration: {
            maxEntries: 100,
            maxAgeSeconds: 60 * 60, // 1 hour
          },
          networkTimeoutSeconds: 10,
        },
      },
    ],
  },
})(nextConfig)
);
