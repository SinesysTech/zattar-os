version: "3.8"

services:
  # ============================================================================
  # APP TIER
  # ============================================================================
  sinesys_app:
    image: sinesys_app:latest
    deploy:
      replicas: 3
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.app.rule=Host(`app.sinesys.com.br`)"
        - "traefik.http.routers.app.entrypoints=websecure"
        - "traefik.http.routers.app.tls.certresolver=letsencrypt"
        - "traefik.http.services.app.loadbalancer.server.port=3000"
      resources:
        limits:
          cpus: "1.0"
          memory: "512M"
    environment:
      - NODE_ENV=production
      - REDIS_SENTINEL_HOSTS=sentinel-1:26379,sentinel-2:26379,sentinel-3:26379
      - REDIS_MASTER_NAME=mymaster
    networks:
      - traefik-net
      - backend-net
      - monitoring-net
    secrets:
      - db_password
      - redis_password
    depends_on:
      - redis-master
      - redis-sentinel-1

  # ============================================================================
  # INFRASTRUCTURE TIER
  # ============================================================================
  traefik:
    image: traefik:v2.10
    command:
      - "--configFile=/etc/traefik/traefik.yml"
    ports:
      - "80:80"
      - "443:443"
      # Dashboard
      - "8080:8080"
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "traefik-certificates:/letsencrypt"
    configs:
      - source: traefik_config
        target: /etc/traefik/traefik.yml
    networks:
      - traefik-net
      - monitoring-net

  # ============================================================================
  # DATA TIER (Redis HA)
  # ============================================================================
  redis-master:
    image: bitnami/redis:7.2
    environment:
      - REDIS_REPLICATION_MODE=master
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
    volumes:
      - redis_data:/bitnami/redis/data
    networks:
      - backend-net
      - monitoring-net
    secrets:
      - redis_password
    deploy:
      placement:
        constraints:
          - node.role == manager

  redis-replica:
    image: bitnami/redis:7.2
    environment:
      - REDIS_REPLICATION_MODE=slave
      - REDIS_MASTER_HOST=redis-master
      - REDIS_MASTER_PASSWORD_FILE=/run/secrets/redis_password
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
    networks:
      - backend-net
      - monitoring-net
    secrets:
      - redis_password
    deploy:
      replicas: 1

  redis-sentinel-1:
    image: bitnami/redis-sentinel:7.2
    environment:
      - REDIS_SENTINEL_DOWN_AFTER_MILLISECONDS=3000
      - REDIS_MASTER_HOST=redis-master
      - REDIS_MASTER_SET=mymaster
      - REDIS_MASTER_PASSWORD_FILE=/run/secrets/redis_password
    networks:
      - backend-net
    secrets:
      - redis_password
    deploy:
      replicas: 1

  redis-sentinel-2:
    image: bitnami/redis-sentinel:7.2
    environment:
      - REDIS_SENTINEL_DOWN_AFTER_MILLISECONDS=3000
      - REDIS_MASTER_HOST=redis-master
      - REDIS_MASTER_SET=mymaster
      - REDIS_MASTER_PASSWORD_FILE=/run/secrets/redis_password
    networks:
      - backend-net
    secrets:
      - redis_password
    deploy:
      replicas: 1

  redis-sentinel-3:
    image: bitnami/redis-sentinel:7.2
    environment:
      - REDIS_SENTINEL_DOWN_AFTER_MILLISECONDS=3000
      - REDIS_MASTER_HOST=redis-master
      - REDIS_MASTER_SET=mymaster
      - REDIS_MASTER_PASSWORD_FILE=/run/secrets/redis_password
    networks:
      - backend-net
    secrets:
      - redis_password
    deploy:
      replicas: 1

  # ============================================================================
  # MONITORING TIER
  # ============================================================================
  prometheus:
    image: prom/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
    configs:
      - source: prometheus_config
        target: /etc/prometheus/prometheus.yml
    networks:
      - monitoring-net
    deploy:
      replicas: 1

  grafana:
    image: grafana/grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ../shared/grafana-dashboards:/var/lib/grafana/dashboards
    networks:
      - monitoring-net
    deploy:
      replicas: 1

  loki:
    image: grafana/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - monitoring-net
    deploy:
      replicas: 1

  promtail:
    image: grafana/promtail
    command: -config.file=/etc/promtail/config.yml
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers
    networks:
      - monitoring-net
    deploy:
      mode: global

networks:
  traefik-net:
    driver: overlay
  backend-net:
    driver: overlay
  monitoring-net:
    driver: overlay

volumes:
  traefik-certificates:
  redis_data:
  grafana_data:

configs:
  traefik_config:
    file: ../shared/traefik.yml
  prometheus_config:
    file: ../shared/prometheus.yml

secrets:
  db_password:
    external: true
  redis_password:
    external: true
