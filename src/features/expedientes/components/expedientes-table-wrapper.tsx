'use client';

/**
 * EXPEDIENTES FEATURE - ExpedientesTableWrapper
 *
 * Componente Client que encapsula a tabela de expedientes.
 * Implementação seguindo o padrão DataShell.
 * Referência: src/features/partes/components/clientes/clientes-table-wrapper.tsx
 */

import * as React from 'react';
import { useRouter } from 'next/navigation';
import type { Table as TanstackTable } from '@tanstack/react-table';
import { format, startOfDay, addDays, startOfWeek, endOfWeek } from 'date-fns';
import { Filter, X, User, FileType, Building2, Scale } from 'lucide-react';

import {
  DataShell,
  DataTable,
  DataTableToolbar,
  DataPagination,
} from '@/components/shared/data-shell';
import { useDebounce } from '@/hooks/use-debounce';
import { DateRangePicker } from '@/components/ui/date-range-picker';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Checkbox } from '@/components/ui/checkbox';
import { Label } from '@/components/ui/label';
import { Separator } from '@/components/ui/separator';
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
  CommandList,
} from '@/components/ui/command';

import type { PaginatedResponse } from '@/lib/types';
import type { Expediente, ListarExpedientesParams, ExpedientesFilters } from '../domain';
import { CodigoTribunal, GrauTribunal, GRAU_TRIBUNAL_LABELS, OrigemExpediente, ORIGEM_EXPEDIENTE_LABELS } from '../domain';
import { actionListarExpedientes } from '../actions';
import { actionListarUsuarios } from '@/features/usuarios';
import { columns } from './columns';
import { ExpedienteDialog } from './expediente-dialog';

// =============================================================================
// TIPOS
// =============================================================================

interface ExpedientesTableWrapperProps {
  initialData?: PaginatedResponse<Expediente>;
  fixedDate?: Date;
  hideDateFilters?: boolean;
}

type UsuarioOption = {
  id: number;
  nomeExibicao?: string;
  nome_exibicao?: string;
  nome?: string;
};

type TipoExpedienteOption = {
  id: number;
  tipoExpediente?: string;
  tipo_expediente?: string;
};

type PrazoFilterType = 'todos' | 'vencidos' | 'hoje' | 'amanha' | 'semana' | 'sem_prazo';
type StatusFilterType = 'todos' | 'pendentes' | 'baixados';
type ResponsavelFilterType = 'todos' | 'sem_responsavel' | number;

// Helper para obter nome do usuário
function getUsuarioNome(u: UsuarioOption): string {
  return u.nomeExibicao || u.nome_exibicao || u.nome || `Usuário ${u.id}`;
}

// Helper para obter nome do tipo
function getTipoNome(t: TipoExpedienteOption): string {
  return t.tipoExpediente || t.tipo_expediente || `Tipo ${t.id}`;
}

// =============================================================================
// COMPONENTE PRINCIPAL
// =============================================================================

export function ExpedientesTableWrapper({ initialData, fixedDate, hideDateFilters }: ExpedientesTableWrapperProps) {
  const router = useRouter();

  // ---------- Estado da Tabela (DataShell pattern) ----------
  const [table, setTable] = React.useState<TanstackTable<Expediente> | null>(null);
  const [density, setDensity] = React.useState<'compact' | 'standard' | 'relaxed'>('standard');

  // ---------- Estado de Paginação ----------
  const [pageIndex, setPageIndex] = React.useState(0);
  const [pageSize, setPageSize] = React.useState(initialData?.pagination.limit || 10);
  const [total, setTotal] = React.useState(initialData?.pagination.total || 0);
  const [totalPages, setTotalPages] = React.useState(initialData?.pagination.totalPages || 0);

  // ---------- Estado de Loading/Error ----------
  const [isLoading, setIsLoading] = React.useState(false);
  const [error, setError] = React.useState<string | null>(null);

  // ---------- Estado dos Dados ----------
  const [expedientes, setExpedientes] = React.useState<Expediente[]>(initialData?.data || []);

  // ---------- Estado de Filtros Primários ----------
  const [busca, setBusca] = React.useState('');
  const [statusFilter, setStatusFilter] = React.useState<StatusFilterType>('pendentes');
  const [prazoFilter, setPrazoFilter] = React.useState<PrazoFilterType>('todos');
  const [responsavelFilter, setResponsavelFilter] = React.useState<ResponsavelFilterType>('todos');
  const [dateRange, setDateRange] = React.useState<{ from?: Date; to?: Date } | undefined>(undefined);

  // ---------- Estado de Filtros Secundários (Mais Filtros) ----------
  const [tribunalFilter, setTribunalFilter] = React.useState<string[]>([]);
  const [grauFilter, setGrauFilter] = React.useState<string[]>([]);
  const [tipoExpedienteFilter, setTipoExpedienteFilter] = React.useState<number[]>([]);
  const [origemFilter, setOrigemFilter] = React.useState<string[]>([]);
  const [semTipoFilter, setSemTipoFilter] = React.useState(false);
  const [segredoJusticaFilter, setSegredoJusticaFilter] = React.useState(false);
  const [prioridadeFilter, setPrioridadeFilter] = React.useState(false);

  // ---------- Estado de Popovers ----------
  const [moreFiltersOpen, setMoreFiltersOpen] = React.useState(false);
  const [responsavelPopoverOpen, setResponsavelPopoverOpen] = React.useState(false);

  // ---------- Estado de Dialogs ----------
  const [isNovoDialogOpen, setIsNovoDialogOpen] = React.useState(false);

  // ---------- Dados Auxiliares ----------
  const [usuarios, setUsuarios] = React.useState<UsuarioOption[]>([]);
  const [tiposExpedientes, setTiposExpedientes] = React.useState<TipoExpedienteOption[]>([]);

  // Debounce da busca (500ms)
  const buscaDebounced = useDebounce(busca, 500);

  // ---------- Carregar dados auxiliares ----------
  React.useEffect(() => {
    const fetchAuxData = async () => {
      try {
        // Fetch users via server action and tipos via API
        const [usersRes, tiposRes] = await Promise.all([
          actionListarUsuarios({ ativo: true, limite: 100 }),
          fetch('/api/tipos-expedientes?limite=100').then((r) => r.json()),
        ]);

        // Handle usuarios from server action
        if (usersRes.success && usersRes.data?.usuarios) {
          setUsuarios(usersRes.data.usuarios as UsuarioOption[]);
        }

        // Handle tipos from API
        const tiposPayload = tiposRes as { success?: boolean; data?: { data?: TipoExpedienteOption[] } };
        const tiposArr = tiposPayload.data?.data;
        if (tiposPayload.success && Array.isArray(tiposArr)) {
          setTiposExpedientes(tiposArr);
        }
      } catch (err) {
        console.error('Erro ao carregar dados auxiliares:', err);
      }
    };
    fetchAuxData();
  }, []);

  // ---------- Calcular datas para filtro de prazo ----------
  const getPrazoDates = React.useCallback((prazo: PrazoFilterType): { from?: string; to?: string } | null => {
    const hoje = new Date();

    switch (prazo) {
      case 'vencidos':
        // Prazo vencido é tratado pelo campo prazoVencido, não por datas
        return null;
      case 'hoje':
        const hojeStr = format(startOfDay(hoje), 'yyyy-MM-dd');
        return { from: hojeStr, to: hojeStr };
      case 'amanha':
        const amanha = addDays(hoje, 1);
        const amanhaStr = format(startOfDay(amanha), 'yyyy-MM-dd');
        return { from: amanhaStr, to: amanhaStr };
      case 'semana':
        // Segunda a Domingo da semana atual
        const inicioSemana = startOfWeek(hoje, { weekStartsOn: 1 });
        const fimSemana = endOfWeek(hoje, { weekStartsOn: 1 });
        return {
          from: format(inicioSemana, 'yyyy-MM-dd'),
          to: format(fimSemana, 'yyyy-MM-dd'),
        };
      case 'sem_prazo':
        // Tratado separadamente
        return null;
      default:
        return null;
    }
  }, []);

  // ---------- Refetch Function ----------
  const refetch = React.useCallback(async () => {
    setIsLoading(true);
    setError(null);

    try {
      const params: ListarExpedientesParams = {
        pagina: pageIndex + 1, // API usa 1-based
        limite: pageSize,
        busca: buscaDebounced || undefined,
      };

      const filters: ExpedientesFilters = {};

      // Filtro de Status (Pendentes/Baixados)
      if (statusFilter === 'pendentes') filters.baixado = false;
      if (statusFilter === 'baixados') filters.baixado = true;

      // Filtro de Prazo
      if (prazoFilter === 'vencidos') {
        filters.prazoVencido = true;
      } else if (prazoFilter === 'sem_prazo') {
        filters.incluirSemPrazo = true;
        // Não definir datas para buscar apenas sem prazo
      } else if (prazoFilter !== 'todos') {
        const prazoDates = getPrazoDates(prazoFilter);
        if (prazoDates) {
          filters.dataPrazoLegalInicio = prazoDates.from;
          filters.dataPrazoLegalFim = prazoDates.to;
        }
      }

      // Filtro de Responsável
      if (responsavelFilter === 'sem_responsavel') {
        filters.semResponsavel = true;
      } else if (typeof responsavelFilter === 'number') {
        filters.responsavelId = responsavelFilter;
      }

      // Date Range (sobrescreve prazoFilter se definido)
      if (dateRange?.from) filters.dataPrazoLegalInicio = format(dateRange.from, 'yyyy-MM-dd');
      if (dateRange?.to) filters.dataPrazoLegalFim = format(dateRange.to, 'yyyy-MM-dd');

      // Fixed Date (override manual filters)
      if (fixedDate) {
        const dateStr = format(fixedDate, 'yyyy-MM-dd');
        filters.dataPrazoLegalInicio = dateStr;
        filters.dataPrazoLegalFim = dateStr;
        filters.incluirSemPrazo = false; // Na visão de dia, geralmente queremos ver o que é do dia
        delete filters.prazoVencido;
      }

      // Filtros Secundários
      if (tribunalFilter.length === 1) {
        filters.trt = tribunalFilter[0] as typeof CodigoTribunal[number];
      }
      if (grauFilter.length === 1) {
        filters.grau = grauFilter[0] as GrauTribunal;
      }
      if (tipoExpedienteFilter.length === 1) {
        filters.tipoExpedienteId = tipoExpedienteFilter[0];
      }
      if (semTipoFilter) {
        filters.semTipo = true;
      }
      if (segredoJusticaFilter) {
        filters.segredoJustica = true;
      }
      // prioridadeProcessual não está no tipo de filtros da API ainda

      const mergedParams: ListarExpedientesParams = {
        ...params,
        ...filters,
      };

      const result = await actionListarExpedientes(mergedParams);

      if (!result.success) {
        throw new Error(result.message || 'Erro ao listar expedientes');
      }

      const responseData = result.data as PaginatedResponse<Expediente>;
      setExpedientes(responseData.data);
      setTotal(responseData.pagination.total);
      setTotalPages(responseData.pagination.totalPages);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Erro desconhecido');
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  }, [
    pageIndex,
    pageSize,
    buscaDebounced,
    statusFilter,
    prazoFilter,
    responsavelFilter,
    dateRange,
    tribunalFilter,
    grauFilter,
    tipoExpedienteFilter,
    semTipoFilter,
    segredoJusticaFilter,
    getPrazoDates,
    fixedDate,
  ]);

  // ---------- Skip First Render ----------
  const isFirstRender = React.useRef(true);

  React.useEffect(() => {
    // Se tivermos dados iniciais, pular o primeiro fetch
    if (isFirstRender.current) {
      isFirstRender.current = false;
      if (initialData) return;
    }
    refetch();
  }, [refetch, initialData]);

  // ---------- Handlers ----------
  const handleSucessoOperacao = React.useCallback(() => {
    refetch();
    router.refresh();
  }, [refetch, router]);

  const handleCreateSuccess = React.useCallback(() => {
    refetch();
    setIsNovoDialogOpen(false);
    router.refresh();
  }, [refetch, router]);

  // Handler para limpar todos os filtros
  const handleClearAllFilters = React.useCallback(() => {
    setStatusFilter('pendentes');
    setPrazoFilter('todos');
    setResponsavelFilter('todos');
    setDateRange(undefined);
    setTribunalFilter([]);
    setGrauFilter([]);
    setTipoExpedienteFilter([]);
    setOrigemFilter([]);
    setSemTipoFilter(false);
    setSegredoJusticaFilter(false);
    setPrioridadeFilter(false);
    setPageIndex(0);
  }, []);

  // Contar filtros ativos
  const activeFiltersCount = React.useMemo(() => {
    let count = 0;
    if (statusFilter !== 'pendentes') count++; // pendentes é o default
    if (prazoFilter !== 'todos') count++;
    if (responsavelFilter !== 'todos') count++;
    if (dateRange?.from || dateRange?.to) count++;
    if (tribunalFilter.length > 0) count++;
    if (grauFilter.length > 0) count++;
    if (tipoExpedienteFilter.length > 0) count++;
    if (origemFilter.length > 0) count++;
    if (semTipoFilter) count++;
    if (segredoJusticaFilter) count++;
    if (prioridadeFilter) count++;
    return count;
  }, [
    statusFilter,
    prazoFilter,
    responsavelFilter,
    dateRange,
    tribunalFilter,
    grauFilter,
    tipoExpedienteFilter,
    origemFilter,
    semTipoFilter,
    segredoJusticaFilter,
    prioridadeFilter,
  ]);

  // Gerar chips de filtros ativos
  const activeFilterChips = React.useMemo(() => {
    const chips: { key: string; label: string; onRemove: () => void }[] = [];

    if (statusFilter !== 'pendentes') {
      chips.push({
        key: 'status',
        label: statusFilter === 'todos' ? 'Todos Status' : 'Baixados',
        onRemove: () => setStatusFilter('pendentes'),
      });
    }

    if (prazoFilter !== 'todos') {
      const prazoLabels: Record<PrazoFilterType, string> = {
        todos: 'Todos',
        vencidos: 'Vencidos',
        hoje: 'Hoje',
        amanha: 'Amanhã',
        semana: 'Esta Semana',
        sem_prazo: 'Sem Prazo',
      };
      chips.push({
        key: 'prazo',
        label: prazoLabels[prazoFilter],
        onRemove: () => setPrazoFilter('todos'),
      });
    }

    if (responsavelFilter === 'sem_responsavel') {
      chips.push({
        key: 'responsavel',
        label: 'Sem Responsável',
        onRemove: () => setResponsavelFilter('todos'),
      });
    } else if (typeof responsavelFilter === 'number') {
      const usuario = usuarios.find((u) => u.id === responsavelFilter);
      chips.push({
        key: 'responsavel',
        label: usuario ? getUsuarioNome(usuario) : `Responsável #${responsavelFilter}`,
        onRemove: () => setResponsavelFilter('todos'),
      });
    }

    if (dateRange?.from || dateRange?.to) {
      const fromStr = dateRange.from ? format(dateRange.from, 'dd/MM') : '';
      const toStr = dateRange.to ? format(dateRange.to, 'dd/MM') : '';
      chips.push({
        key: 'dateRange',
        label: `${fromStr} - ${toStr}`,
        onRemove: () => setDateRange(undefined),
      });
    }

    tribunalFilter.forEach((trt) => {
      chips.push({
        key: `tribunal-${trt}`,
        label: trt,
        onRemove: () => setTribunalFilter((prev) => prev.filter((t) => t !== trt)),
      });
    });

    grauFilter.forEach((grau) => {
      chips.push({
        key: `grau-${grau}`,
        label: GRAU_TRIBUNAL_LABELS[grau as GrauTribunal] || grau,
        onRemove: () => setGrauFilter((prev) => prev.filter((g) => g !== grau)),
      });
    });

    tipoExpedienteFilter.forEach((tipoId) => {
      const tipo = tiposExpedientes.find((t) => t.id === tipoId);
      chips.push({
        key: `tipo-${tipoId}`,
        label: tipo ? getTipoNome(tipo) : `Tipo #${tipoId}`,
        onRemove: () => setTipoExpedienteFilter((prev) => prev.filter((t) => t !== tipoId)),
      });
    });

    origemFilter.forEach((origem) => {
      chips.push({
        key: `origem-${origem}`,
        label: ORIGEM_EXPEDIENTE_LABELS[origem as OrigemExpediente] || origem,
        onRemove: () => setOrigemFilter((prev) => prev.filter((o) => o !== origem)),
      });
    });

    if (semTipoFilter) {
      chips.push({
        key: 'semTipo',
        label: 'Sem Tipo',
        onRemove: () => setSemTipoFilter(false),
      });
    }

    if (segredoJusticaFilter) {
      chips.push({
        key: 'segredo',
        label: 'Segredo de Justiça',
        onRemove: () => setSegredoJusticaFilter(false),
      });
    }

    if (prioridadeFilter) {
      chips.push({
        key: 'prioridade',
        label: 'Prioridade',
        onRemove: () => setPrioridadeFilter(false),
      });
    }

    return chips;
  }, [
    statusFilter,
    prazoFilter,
    responsavelFilter,
    dateRange,
    tribunalFilter,
    grauFilter,
    tipoExpedienteFilter,
    origemFilter,
    semTipoFilter,
    segredoJusticaFilter,
    prioridadeFilter,
    usuarios,
    tiposExpedientes,
  ]);

  // ---------- Render ----------
  return (
    <>
      <DataShell
        actionButton={{
          label: 'Novo Expediente',
          onClick: () => setIsNovoDialogOpen(true),
        }}
        header={
          table ? (
            <div className="flex flex-col gap-3">
              <DataTableToolbar
                table={table}
                density={density}
                onDensityChange={setDensity}
                searchValue={busca}
                onSearchValueChange={(value) => {
                  setBusca(value);
                  setPageIndex(0);
                }}
                searchPlaceholder="Buscar expedientes..."
                actionButton={{
                  label: 'Novo Expediente',
                  onClick: () => setIsNovoDialogOpen(true),
                }}
                filtersSlot={
                  <>
                    {/* Status Filter */}
                    <Select
                      value={statusFilter}
                      onValueChange={(v: StatusFilterType) => {
                        setStatusFilter(v);
                        setPageIndex(0);
                      }}
                    >
                      <SelectTrigger className="h-10 w-[130px] bg-card">
                        <SelectValue placeholder="Status" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="todos">Todos</SelectItem>
                        <SelectItem value="pendentes">Pendentes</SelectItem>
                        <SelectItem value="baixados">Baixados</SelectItem>
                      </SelectContent>
                    </Select>

                    {/* Prazo Filter - Hide if date is fixed */}
                    {!hideDateFilters && (
                      <Select
                        value={prazoFilter}
                        onValueChange={(v: PrazoFilterType) => {
                          setPrazoFilter(v);
                          setDateRange(undefined); // Limpa date range ao usar prazo
                          setPageIndex(0);
                        }}
                      >
                        <SelectTrigger className="h-10 w-[150px] bg-card">
                          <SelectValue placeholder="Prazo" />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="todos">Todos Prazos</SelectItem>
                          <SelectItem value="vencidos">Vencidos</SelectItem>
                          <SelectItem value="hoje">Vence Hoje</SelectItem>
                          <SelectItem value="amanha">Vence Amanhã</SelectItem>
                          <SelectItem value="semana">Esta Semana</SelectItem>
                          <SelectItem value="sem_prazo">Sem Prazo</SelectItem>
                        </SelectContent>
                      </Select>
                    )}

                    {/* Responsável Filter */}
                    <Popover open={responsavelPopoverOpen} onOpenChange={setResponsavelPopoverOpen}>
                      <PopoverTrigger asChild>
                        <Button variant="outline" className="h-10 w-[160px] justify-between bg-card">
                          <User className="h-4 w-4 mr-2 shrink-0" />
                          <span className="truncate">
                            {responsavelFilter === 'todos'
                              ? 'Responsável'
                              : responsavelFilter === 'sem_responsavel'
                                ? 'Sem Responsável'
                                : getUsuarioNome(usuarios.find((u) => u.id === responsavelFilter) || { id: responsavelFilter as number })}
                          </span>
                        </Button>
                      </PopoverTrigger>
                      <PopoverContent className="w-[240px] p-0" align="start">
                        <Command>
                          <CommandInput placeholder="Buscar usuário..." />
                          <CommandList>
                            <CommandEmpty>Nenhum usuário encontrado.</CommandEmpty>
                            <CommandGroup>
                              <CommandItem
                                value="todos"
                                onSelect={() => {
                                  setResponsavelFilter('todos');
                                  setResponsavelPopoverOpen(false);
                                  setPageIndex(0);
                                }}
                              >
                                Todos
                              </CommandItem>
                              <CommandItem
                                value="sem_responsavel"
                                onSelect={() => {
                                  setResponsavelFilter('sem_responsavel');
                                  setResponsavelPopoverOpen(false);
                                  setPageIndex(0);
                                }}
                              >
                                Sem Responsável
                              </CommandItem>
                              <Separator className="my-1" />
                              {usuarios.map((usuario) => (
                                <CommandItem
                                  key={usuario.id}
                                  value={getUsuarioNome(usuario)}
                                  onSelect={() => {
                                    setResponsavelFilter(usuario.id);
                                    setResponsavelPopoverOpen(false);
                                    setPageIndex(0);
                                  }}
                                >
                                  {getUsuarioNome(usuario)}
                                </CommandItem>
                              ))}
                            </CommandGroup>
                          </CommandList>
                        </Command>
                      </PopoverContent>
                    </Popover>

                    {/* Date Range Picker - Hide if date is fixed */}
                    {!hideDateFilters && (
                      <DateRangePicker
                        value={dateRange}
                        onChange={(range) => {
                          setDateRange(range);
                          if (range?.from || range?.to) {
                            setPrazoFilter('todos'); // Limpa prazo ao usar date range
                          }
                          setPageIndex(0);
                        }}
                        placeholder="Período"
                        className="h-10 w-[240px] bg-card"
                      />
                    )}

                    {/* More Filters Button */}
                    <Popover open={moreFiltersOpen} onOpenChange={setMoreFiltersOpen}>
                      <PopoverTrigger asChild>
                        <Button variant="outline" className="h-10 gap-2 bg-card">
                          <Filter className="h-4 w-4" />
                          Mais Filtros
                          {activeFiltersCount > 0 && (
                            <Badge variant="secondary" className="h-5 px-1.5 text-xs">
                              {activeFiltersCount}
                            </Badge>
                          )}
                        </Button>
                      </PopoverTrigger>
                      <PopoverContent className="w-[320px]" align="end">
                        <div className="grid gap-4">
                          <div className="space-y-2">
                            <h4 className="font-medium leading-none">Filtros Avançados</h4>
                            <p className="text-sm text-muted-foreground">
                              Configure filtros adicionais para refinar sua busca.
                            </p>
                          </div>
                          <Separator />

                          {/* Tribunal */}
                          <div className="space-y-2">
                            <Label className="flex items-center gap-2">
                              <Building2 className="h-4 w-4" />
                              Tribunal
                            </Label>
                            <Select
                              value={tribunalFilter[0] || '_all'}
                              onValueChange={(v) => {
                                setTribunalFilter(v === '_all' ? [] : [v]);
                                setPageIndex(0);
                              }}
                            >
                              <SelectTrigger className="h-9">
                                <SelectValue placeholder="Selecione..." />
                              </SelectTrigger>
                              <SelectContent>
                                <SelectItem value="_all">Todos</SelectItem>
                                {CodigoTribunal.map((trt) => (
                                  <SelectItem key={trt} value={trt}>
                                    {trt}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                          </div>

                          {/* Grau */}
                          <div className="space-y-2">
                            <Label className="flex items-center gap-2">
                              <Scale className="h-4 w-4" />
                              Grau
                            </Label>
                            <Select
                              value={grauFilter[0] || '_all'}
                              onValueChange={(v) => {
                                setGrauFilter(v === '_all' ? [] : [v]);
                                setPageIndex(0);
                              }}
                            >
                              <SelectTrigger className="h-9">
                                <SelectValue placeholder="Selecione..." />
                              </SelectTrigger>
                              <SelectContent>
                                <SelectItem value="_all">Todos</SelectItem>
                                {Object.entries(GRAU_TRIBUNAL_LABELS).map(([value, label]) => (
                                  <SelectItem key={value} value={value}>
                                    {label}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                          </div>

                          {/* Tipo de Expediente */}
                          <div className="space-y-2">
                            <Label className="flex items-center gap-2">
                              <FileType className="h-4 w-4" />
                              Tipo de Expediente
                            </Label>
                            <Select
                              value={tipoExpedienteFilter[0]?.toString() || '_all'}
                              onValueChange={(v) => {
                                setTipoExpedienteFilter(v === '_all' ? [] : [parseInt(v, 10)]);
                                setSemTipoFilter(false);
                                setPageIndex(0);
                              }}
                            >
                              <SelectTrigger className="h-9">
                                <SelectValue placeholder="Selecione..." />
                              </SelectTrigger>
                              <SelectContent>
                                <SelectItem value="_all">Todos</SelectItem>
                                {tiposExpedientes.map((tipo) => (
                                  <SelectItem key={tipo.id} value={tipo.id.toString()}>
                                    {getTipoNome(tipo)}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                          </div>

                          {/* Origem */}
                          <div className="space-y-2">
                            <Label>Origem</Label>
                            <Select
                              value={origemFilter[0] || '_all'}
                              onValueChange={(v) => {
                                setOrigemFilter(v === '_all' ? [] : [v]);
                                setPageIndex(0);
                              }}
                            >
                              <SelectTrigger className="h-9">
                                <SelectValue placeholder="Selecione..." />
                              </SelectTrigger>
                              <SelectContent>
                                <SelectItem value="_all">Todas</SelectItem>
                                {Object.entries(ORIGEM_EXPEDIENTE_LABELS).map(([value, label]) => (
                                  <SelectItem key={value} value={value}>
                                    {label}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                          </div>

                          <Separator />

                          {/* Checkboxes */}
                          <div className="space-y-3">
                            <div className="flex items-center space-x-2">
                              <Checkbox
                                id="semTipo"
                                checked={semTipoFilter}
                                onCheckedChange={(checked) => {
                                  setSemTipoFilter(!!checked);
                                  if (checked) setTipoExpedienteFilter([]);
                                  setPageIndex(0);
                                }}
                              />
                              <Label htmlFor="semTipo" className="text-sm cursor-pointer">
                                Sem Tipo Definido
                              </Label>
                            </div>
                            <div className="flex items-center space-x-2">
                              <Checkbox
                                id="segredo"
                                checked={segredoJusticaFilter}
                                onCheckedChange={(checked) => {
                                  setSegredoJusticaFilter(!!checked);
                                  setPageIndex(0);
                                }}
                              />
                              <Label htmlFor="segredo" className="text-sm cursor-pointer">
                                Segredo de Justiça
                              </Label>
                            </div>
                            <div className="flex items-center space-x-2">
                              <Checkbox
                                id="prioridade"
                                checked={prioridadeFilter}
                                onCheckedChange={(checked) => {
                                  setPrioridadeFilter(!!checked);
                                  setPageIndex(0);
                                }}
                              />
                              <Label htmlFor="prioridade" className="text-sm cursor-pointer">
                                Prioridade Processual
                              </Label>
                            </div>
                          </div>

                          <Separator />

                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => {
                              handleClearAllFilters();
                              setMoreFiltersOpen(false);
                            }}
                          >
                            Limpar Filtros
                          </Button>
                        </div>
                      </PopoverContent>
                    </Popover>
                  </>
                }
              />

              {/* Active Filter Chips */}
              {activeFilterChips.length > 0 && (
                <div className="flex flex-wrap items-center gap-2 px-4">
                  <span className="text-sm text-muted-foreground">Filtros:</span>
                  {activeFilterChips.map((chip) => (
                    <Badge
                      key={chip.key}
                      variant="secondary"
                      className="gap-1 pr-1 cursor-pointer hover:bg-secondary/80"
                    >
                      {chip.label}
                      <Button
                        variant="ghost"
                        size="icon"
                        className="h-4 w-4 p-0 hover:bg-transparent"
                        onClick={chip.onRemove}
                      >
                        <X className="h-3 w-3" />
                      </Button>
                    </Badge>
                  ))}
                  {activeFilterChips.length > 1 && (
                    <Button
                      variant="ghost"
                      size="sm"
                      className="h-6 px-2 text-xs"
                      onClick={handleClearAllFilters}
                    >
                      Limpar todos
                    </Button>
                  )}
                </div>
              )}
            </div>
          ) : undefined
        }
        footer={
          totalPages > 0 ? (
            <DataPagination
              pageIndex={pageIndex}
              pageSize={pageSize}
              total={total}
              totalPages={totalPages}
              onPageChange={setPageIndex}
              onPageSizeChange={(size) => {
                setPageSize(size);
                setPageIndex(0);
              }}
              isLoading={isLoading}
            />
          ) : null
        }
      >
        <div className="relative border-t">
          <DataTable
            data={expedientes}
            columns={columns}
            isLoading={isLoading}
            error={error}
            density={density}
            onTableReady={(t) => setTable(t as TanstackTable<Expediente>)}
            hideTableBorder={true}
            emptyMessage="Nenhum expediente encontrado."
            options={{
              meta: {
                usuarios,
                tiposExpedientes,
                onSuccess: handleSucessoOperacao,
              },
            }}
          />
        </div>
      </DataShell >

      <ExpedienteDialog
        open={isNovoDialogOpen}
        onOpenChange={setIsNovoDialogOpen}
        onSuccess={handleCreateSuccess}
      />
    </>
  );
}

