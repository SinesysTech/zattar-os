'use client';

import * as React from 'react';
import { Column } from '@tanstack/react-table';
import { Check, PlusCircle, ChevronDown } from 'lucide-react';

import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
  CommandList,
  CommandSeparator,
} from '@/components/ui/command';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Separator } from '@/components/ui/separator';
import { Input } from '@/components/ui/input';
import { cn } from '@/lib/utils';

interface DataTableFilterProps<TData, TValue> {
  column?: Column<TData, TValue>;
  title?: string;
  options?: {
    label: string;
    value: string;
    icon?: React.ComponentType<{ className?: string }>;
  }[];
  variant?: 'inline' | 'stacked';
}

export function DataTableFilter<TData, TValue>({
  column,
  title,
  options,
  variant = 'inline',
}: DataTableFilterProps<TData, TValue>) {
  const facets = column?.getFacetedUniqueValues();
  const selectedValues = new Set(column?.getFilterValue() as string[]);

  // Determine filter type from meta or implicit
  const meta = column?.columnDef.meta as { filterVariant?: string } | undefined;
  const filterType = meta?.filterVariant || 'text';

  const renderTrigger = () => (
      <Button variant="outline" size="sm" className={cn("h-9 w-full justify-between", variant === 'stacked' && "mt-1")}>
        <span className="flex items-center truncate">
            {variant === 'inline' && <PlusCircle className="mr-2 h-4 w-4" />}
            {variant === 'inline' ? title : "Todos"}
            {selectedValues?.size > 0 && (
            <>
                {variant === 'inline' && <Separator orientation="vertical" className="mx-2 h-4" />}
                <Badge
                    variant="secondary"
                    className="rounded-sm px-1 font-normal lg:hidden"
                >
                    {selectedValues.size}
                </Badge>
                <div className="hidden space-x-1 lg:flex ml-2">
                    {selectedValues.size > 2 ? (
                        <Badge
                        variant="secondary"
                        className="rounded-sm px-1 font-normal"
                        >
                        {selectedValues.size} selected
                        </Badge>
                    ) : (
                        options
                        ?.filter((option) => selectedValues.has(option.value))
                        .map((option) => (
                            <Badge
                            key={option.value}
                            variant="secondary"
                            className="rounded-sm px-1 font-normal"
                            >
                            {option.label}
                            </Badge>
                        ))
                    )}
                </div>
            </>
            )}
        </span>
        <ChevronDown className="h-4 w-4 opacity-50" />
      </Button>
  );

  if (filterType === 'select' && options) {
    const Component = (
         <Popover>
            <PopoverTrigger asChild>
                {renderTrigger()}
            </PopoverTrigger>
            <PopoverContent className="w-[200px] p-0" align="start">
            <Command>
                <CommandInput placeholder={title} />
                <CommandList>
                <CommandEmpty>No results found.</CommandEmpty>
                <CommandGroup>
                    {options.map((option) => {
                    const isSelected = selectedValues.has(option.value);
                    return (
                        <CommandItem
                        key={option.value}
                        onSelect={() => {
                            if (isSelected) {
                            selectedValues.delete(option.value);
                            } else {
                            selectedValues.add(option.value);
                            }
                            const filterValues = Array.from(selectedValues);
                            column?.setFilterValue(
                            filterValues.length ? filterValues : undefined
                            );
                        }}
                        >
                        <div
                            className={cn(
                            'mr-2 flex h-4 w-4 items-center justify-center rounded-sm border border-primary',
                            isSelected
                                ? 'bg-primary text-primary-foreground'
                                : 'opacity-50 [&_svg]:invisible'
                            )}
                        >
                            <Check className={cn('h-4 w-4')} />
                        </div>
                        {option.icon && (
                            <option.icon className="mr-2 h-4 w-4 text-muted-foreground" />
                        )}
                        <span>{option.label}</span>
                        {facets?.get(option.value) && (
                            <span className="ml-auto flex h-4 w-4 items-center justify-center font-mono text-xs">
                            {facets.get(option.value)}
                            </span>
                        )}
                        </CommandItem>
                    );
                    })}
                </CommandGroup>
                {selectedValues.size > 0 && (
                    <>
                    <CommandSeparator />
                    <CommandGroup>
                        <CommandItem
                        onSelect={() => column?.setFilterValue(undefined)}
                        className="justify-center text-center"
                        >
                        Clear filters
                        </CommandItem>
                    </CommandGroup>
                    </>
                )}
                </CommandList>
            </Command>
            </PopoverContent>
        </Popover>
    );

    if (variant === 'stacked') {
        return (
            <div className="flex flex-col">
                <span className="text-sm font-medium">{title}</span>
                {Component}
            </div>
        )
    }
    return Component;
  }

  // Use range slider or min/max inputs if needed
  if (filterType === 'range') {
    // Placeholder for Range Filter (can be expanded later)
    return (
      <div className={cn("flex items-center space-x-2", variant === 'stacked' && "flex-col items-start space-x-0 space-y-1")}>
          {variant === 'stacked' && <span className="text-sm font-medium">{title}</span>}
          <div className="flex items-center space-x-2">
            <Input
                placeholder={`Min`}
                value={(column?.getFilterValue() as [number, number])?.[0] ?? ''}
                onChange={(event) =>
                column?.setFilterValue((old: [number, number]) => [
                    event.target.value ? Number(event.target.value) : undefined,
                    old?.[1],
                ])
                }
                className="h-9 w-[70px]"
                type="number"
            />
            <span className="text-muted-foreground">-</span>
            <Input
                placeholder={`Max`}
                value={(column?.getFilterValue() as [number, number])?.[1] ?? ''}
                onChange={(event) =>
                column?.setFilterValue((old: [number, number]) => [
                    old?.[0],
                    event.target.value ? Number(event.target.value) : undefined,
                ])
                }
                className="h-9 w-[70px]"
                type="number"
            />
          </div>
      </div>
    );
  }

  // Default to text input
  return (
    <div className={cn(variant === 'stacked' ? "flex flex-col space-y-1" : "")}>
        {variant === 'stacked' && <span className="text-sm font-medium">{title}</span>}
        <Input
        placeholder={`Filter ${title}...`}
        value={(column?.getFilterValue() as string) ?? ''}
        onChange={(event) => column?.setFilterValue(event.target.value)}
        className={cn("h-9", variant === 'inline' && "w-[150px] lg:w-[250px]")}
        />
    </div>
  );
}
